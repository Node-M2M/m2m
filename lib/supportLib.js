/*!
 * supportLib.js
 * v2.3.9
 *
 * Copyright(c) 2020 Ed Alegrid
 *
 */
"use strict";const _WebSocket=require("ws"),colors=require("colors"),inquirer=require("inquirer"),m2mv=require("../package.json"),fs=require("fs"),os=require("os"),ip=require("ip"),crypto=require("crypto"),{spawn:spawn,spawnSync:spawnSync,execFileSync:execFileSync}=require("child_process"),{match:match}=require("assert"),processArgs=process.argv.slice(2);let spl={},socket=null,options={};exports.setLibDefaults=function(e,t){e&&(spl=e),t&&(socket=t)},exports.m2mUtilLib=function(e){const t=/^[A-Za-z0-9-_\/]*$/,n=/^[A-Za-z0-9 \[\]"{}':,._-]*$/;let o=null,r="m2mConfig/sec/",s=r+"ptk",i=r+"tk",a=r+"pk",c=process.pid,l=null,u=null,f=!1,m="m2mConfig/eLog",g=35e3,d="                  Date                                           Event";function p(e,t){fs.mkdir("m2mConfig/",(n=>{try{if(n)throw n;e?fs.writeFileSync(e,d):fs.writeFileSync(m,d),t&&t()}catch(e){if("EEXIST"!==e.code)throw console.log("initLog error:",n.message),e.message}}))}function h(e,t,n,o,r,s,i,a,c,l){try{r||(r=""),s||(s=""),i||(i=""),a||(a=""),c||(c=""),l||(l=""),function(e,t,n,o,r,s,i,a,c,l){fs.open(e,"r",((t,u)=>{t&&"ENOENT"===t.code&&fs.writeFileSync(e,d);try{fs.appendFileSync(e,"\n"+n+"  "+o+"  "+r+"  "+s+"  "+i+"  "+a+"  "+c+"  "+l)}catch(t){throw t}})),fs.stat(e,((u,f)=>{if(u&&"ENOENT"===u.code&&p(),f&&f.size>t)try{fs.writeFileSync(e,d),fs.appendFileSync(e,"\n"+n+"  "+o+"  "+r+"  "+s+"  "+i+"  "+a+"  "+c+"  "+l)}catch(u){throw u}}))}(e,t,n,o,r,s,i,a,c,l)}catch(e){throw e}}function y(e,t,n,o,r,s,i){let a=new Date,c=a.toDateString()+" "+a.toLocaleTimeString();h(m,g,c,e,t,n,o,r,s,i)}function v(){fs.mkdir(r,(e=>{e||function(){try{fs.writeFileSync(s,i),fs.writeFileSync(a,"node-m2m")}catch(e){y("setSecTk - fs.writeFileSync error:",e.message)}}()}))}f=!("start"!==process.env.npm_lifecycle_event&&!process.env.npm_package_nodemonConfig_restartable),p(),y("process starting pid","("+process.pid+")"),v(),o="linux"===os.platform()?execFileSync("npm",["-v"]):"win32"===os.platform()?execFileSync("npm -v",{shell:!0}):execFileSync("npm",["-v"]);const E={nodev:process.version,npmv:o.toString("utf8"),type:os.arch(),mem:{total:(os.totalmem()/1e6).toFixed(0)+" MB",free:(os.freemem()/1e6).toFixed(0)+" MB"},m2mv:"v"+m2mv.version,os:os.platform(),container:function(){try{return!(c.toString().length>1||(y("process running in container",!0),0))}catch(e){y("isContainer error:",e.message)}}(),ip:ip.address()};function S(){return l=new Date,l}return S(),{st:S,et:function(){return u=new Date,u-l+" ms"},rid:function(e){return crypto.randomBytes(e).toString("hex")},secTkn:{getPtk:function(){return s},getRtk:function(){return i},getRpk:function(){return a},initSec:v,setToBuffer:function(e,t){try{if("base64"===t)return Buffer.from(JSON.stringify(e)).toString("base64");if("hex"===t)return Buffer.from(JSON.stringify(e)).toString("hex")}catch(e){y("setToBuffer error:",e.message)}}},m2mInfo:function(e,t){try{console.log("\n**************************************"),console.log("   m2m ver:",m2mv.version),console.log("   os:",process.platform),console.log("   h/w type:",os.arch()),e.device?(console.log("   endpoint: device"),e.id&&console.log("   id:",e.id)):e.client?(console.log("   endpoint: client"),e.clientId&&console.log("   id:",e.clientId)):e.edgeUser&&e.user?(console.log("   endpoint: edge (user)"),e.userId&&console.log("   id:",e.userId)):e.user&&!e.edgeUser&&(console.log("   endpoint: user"),e.userId&&console.log("   id:",e.userId)),console.log("   server:",colors.brightBlue(t),"\n**************************************")}catch(e){y("m2mInfo error:",e.message)}},logData:function(e,t,n,o,r,s,i,a){let c=new Date,l=c.toDateString()+" "+c.toLocaleTimeString();h(e,g,l,t,n,o,r,s,i,a)},logEvent:y,setError:function(t,n,o){let r=new Error(t);if(y("error:",r.message),e.emit("node-m2m-error",r),n)n({error:r.message});else{if(!o)throw r;o(r)}},systemInfo:E,getUrlKeys:function(e,t){let n=null;const o=[],r=[],s={};t.startsWith("/")||m2mUtil.setError(new Error("path: "+e.name+" - invalid url path, it must begin with a slash /"),null,null);let i=t.indexOf("?",1);-1!==i&&(n=t.substring(i+1,t.length)),new URLSearchParams(n).forEach((function(e,t){s[t]=e}));let a=t.indexOf("?");-1!==a&&(t=t.slice(0,a));for(let e=0;e<t.length;e++)"/"===t[e]&&o.push(e);return o.forEach(((e,n)=>{try{if(0==e&&o[n+1]){let e=t.slice(o[n],o[n+1]);r.push(e)}else if(0!==e&&o[n]&&o[n+1]){let e=t.slice(o[n],o[n+1]);r.push(e)}else{let e=t.slice(o[n],t.length);r.push(e)}}catch(e){m2mUtil.logEvent("urlRoutesIndex.forEach error:",e.message)}})),e.urlPathKeys=r,e.baseUrl=r[0],e.query=s,e},getSubTopic:function(e,t){const n=[],o=[];if(!t.startsWith("/"))return e;if(t.includes("?"))throw t+" - invalid topic attribute";for(let e=0;e<t.length;e++)("/"===t[e]||"#"===t[e])&&n.push(e);n.forEach((function(e,r){if(0===e&&n[r+1]){let e=t.slice(n[r],n[r+1]);o.push(e)}else if(0!==e&&n[r]&&n[r+1]){let e=t.slice(n[r],n[r+1]);o.push(e)}else{let e=t.slice(n[r],t.length);o.push(e)}}));let r={};o[0]===t&&1===o.length&&(r.root=o[0]);let s=o[0].length,i=t.slice(s);return e.topicKeys=o,e.baseTopic=o[0],e.subTopic=i,e.rootTopic=r.root,e},getParamKeys:function(e){const t={},n=[],o=[],r={},s=[];for(let t=0;t<e.length;t++)"/"===e[t]&&n.push(t);return n.forEach(((t,r)=>{if(0==t&&n[r+1]){let t=e.slice(n[r],n[r+1]);o.push(t)}else if(0!==t&&n[r]&&n[r+1]){let t=e.slice(n[r],n[r+1]);o.push(t)}else{let t=e.slice(n[r],e.length);o.push(t)}})),o.forEach(((e,t)=>{if(e.startsWith("/:")){let n=e.slice(2,e.length),o={key:n,index:t};r[n]=n,s.push(o)}})),t.urlPathKeys=o,t.baseUrl=o[0],t.params=r,t.paramKeys=s,t.rootPath=o[0],t},startConnect:function(t,n){let o="emit-connect";t&&t.resetDeviceSetup(),e.listenerCount(o)<1&&e.on(o,(e=>{if(n||console.log(e),n)if(n.length>0){if(Array.isArray(e))return n("registration fail");setImmediate(n,e)}else{if(Array.isArray(e))return console.log("registration fail");console.log("connection:",e),setImmediate(n)}}))},setDataEvent:function(e,t){try{if(t.length>0)for(let n=0;n<t.length;n++)if(t[n]&&e.name&&e.event&&t[n].id===e.id&&t[n].name===e.name)return!0;return t.push(e),!1}catch(e){y("setDataEvent error:",e.message)}},eventLogHeader:d,getRestartStatus:function(){return f},setEpErrorEvent:function(t,n){if("error"!==t)throw new Error(t+" event name is invalid");let o="node-m2m-"+t;e.listenerCount(o)<1&&e.on(o,(e=>{if("object"==typeof e)return n(e);"string"==typeof e&&n(e)}))},argv:processArgs,validateNameAndPayload:function(e){let o=!0,r=null,s=null;try{if(!e)return void y("validateNameAndPayload !arg:",JSON.stringify(e));if(Array.isArray(e)&&(s=e[0]),s&&(e=s),e.name&&("string"!=typeof e.name&&(o=null),e.name.length>75&&(o=null),e.name.match(t),!o))throw new Error("invalid channel/path");if((e.payload||e.body)&&(e.payload?r=e.payload:e.body&&(r=e.body),"number"==typeof r||"object"==typeof r||"string"==typeof r||(o=null)),r&&(r=JSON.stringify(r),r&&r.length>500&&(o=null),r&&r.match(n),!o))throw e.payload&&(e.payload=null,y("write/sendData - invalid payload data",r)),e.body&&(e.body=null,y("post - invalid body data",r)),new Error("invalid payload/body");return o}catch(e){throw y("validateNameAndPayload error:",e.message),e}},removeDuplicateInArray:function(e){return Array.from(new Set(e))},validateClientApi:function(e,t,n,o,r,s,i,a){let c={};if("string"==typeof e&&r&&("function"==typeof t&&(i=t,"watch"===s&&(o=5e3)),"function"==typeof n&&(i=n),"function"==typeof o&&(i=o,Number.isInteger(t)&&(o=t)),"write"!==s&&"sendData"!==s&&"post"!==s||(n=t),t=e,e=r),Number.isInteger(e)?(c.id=e,"string"==typeof t&&("get"===s||"post"===s?c.path=t:c.channel=t),"number"!=typeof n&&"string"!=typeof n&&"object"!=typeof n||("post"===s?c.body=n:"write"!==s&&"sendData"!==s||(c.payload=n)),"function"==typeof o&&(i=o,o=5e3),Number.isInteger(o)&&(c.interval=o)):"object"==typeof e&&(i=t,r&&(e.id=r),"watch"===s&&(e.interval||(e.interval=5e3)),"function"==typeof t&&(i=t),c=e),!c.id)throw console.log(c),new Error("validateClientApi error - missing id");if("get"===s||"post"===s){if(!c.path)throw console.log(c),new Error("validateClientApi error - missing path")}else if(c.topic);else if(!c.channel)throw console.log(c),new Error("validateClientApi error - missing channel");if("post"===s){if(!c.body)throw console.log(c),new Error("validateClientApi error - missing body")}else if(("write"===s||"sendData"===s)&&!c.payload)throw console.log(c),new Error("validateClientApi error - missing payload");if("watch"===s&&!c.interval)throw console.log(c),new Error("validateClientApi error - missing interval");return new Promise((function(e,t){"function"==typeof i&&(e=null,t=null),a(c,s,i,e,t)}))},removeDuplicateObjectInArray:e=>{if(!Array.isArray(e))return y("filterArray invalid array input:",""+e),!1;try{return e.filter(((t,n)=>n===e.findIndex((e=>t.title===e.title))))}catch(e){y("filterArray error:",e.message)}}}};const dmLib=exports.dmLib=e=>{let t=[],n=1,o={},r=!0,s=6e4,i=null,a=1,c=60,l={r:"r",w:"w"},u=!1,f=[],m=[],g=[],d=[],p=[],h=[],y=[],v=[],E=[],S={},w=[];function b(e,t){let n="m2mConfig/ar",o="base64",r="utf8";try{if("r"===e){let e=fs.readFileSync(n,"utf8");e&&(S=JSON.parse(Buffer.from(e,o).toString(r)))}else if("w"===e&&Object.keys(S).length>0&&S.accessRateData&&S.accessRateData[0]){let e=JSON.stringify(S),t=Buffer.from(e,r).toString(o);fs.writeFileSync(n,t)}}catch(e){}}function C(e){a=1,r=!1,f=[],m=[],g=[],d=[],p=[],h=[],y=[],v=[],E=[],S={},S.accessCounter=1,S.monStatus=!1,clearTimeout(i)}function k(e,t){e.forEach(((e,n)=>{let o={id:spl.id,name:e,cpm:0,tcpm:0,arpm:0};t.push(o)}))}function x(e){e.forEach(((e,t)=>{e.tcpm=e.tcpm+e.cpm,e.arpm=(e.tcpm/a).toFixed(n),e.iteration=a;let o=Object.assign({},e);e.tcpm&&E.push(o),e.cpm=0}))}function F(t){r=!0,S.monStatus=!0,t&&(o=t.resources.getDeviceResources());let n=o.publish.name,u=o.dataSource.name,A=o.get.path,O=o.post.path;1===a&&(k(n,f),k(u,m),k(A,g),k(O,d)),E=[],i=setTimeout((()=>{r=!1,clearTimeout(i),w.forEach(((t,n)=>{try{t.name&&t.watch&&"watch"===t.method?f.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.watch=!0)})):t.name&&t.getData&&"getData"===t.method?m.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.getData=!0)})):t.name&&t.sendData&&"sendData"===t.method?m.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.sendData=!0)})):t.name&&t.read&&"read"===t.method?m.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.read=!0)})):t.name&&t.write&&"write"===t.method?m.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.write=!0)})):t.name&&t.get&&"get"===t.method?g.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.get=!0)})):t.name&&t.post&&"post"===t.method&&d.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.post=!0)}))}catch(t){e&&e.logEvent("accessRateMonitoring error:",t.message)}})),x(f),x(m),x(g),x(d),x(p),x(h),x(y),x(v),setImmediate((()=>{S={accessRateData:E,monStatus:!0,accessCounter:a},w=[],setTimeout((()=>{a<c?(b(l.w),a++,F(t)):(C(),b(l.w),setTimeout((()=>{F(t)}),25))}),1e3)}))}),s)}function A(t,n){return t.push("&nbsp"+n),e.removeDuplicateInArray(t)}return{resources:{collectAccessData:function(e){r&&w.push(e)},getClientAccessData:function(n){return u?t:function(n){let o=function(e){let t=[],n=e.getValidDeviceId();return e.getClientRawAccessData().forEach((e=>{n.includes(e.id)&&t.push(e)})),t}(n);return o.forEach((n=>function(n){let o=!1,r=e.systemInfo.ip,s={id:n.id,clientId:n.clientId,ip:r,sub:[],read:[],write:[],get:[],post:[],inputGetState:[],inputWatch:[],outputGetState:[],outputOn:[],outputOff:[]};t.forEach(((e,t)=>{e.id===n.id&&(o=!0)})),!1===o&&t.push(s)}(n))),t.forEach(((t,n)=>{o.forEach(((n,o)=>{try{t.id===n.id&&(n.getData&&n.name?t.read=A(t.read,n.name):n.sendData&&n.name?t.write=A(t.write,n.name):n.read&&n.name?t.read=A(t.read,n.name):n.write&&n.name?t.write=A(t.write,n.name):n.watch&&n.name?t.sub=A(t.sub,n.name):n.get&&n.name?t.get=A(t.get,n.name):n.post&&n.name?t.post=A(t.post,n.name):n.gpioInput&&n.watch&&n.pin?t.inputWatch=A(t.inputWatch,n.pin):n.gpioInput&&n.getState&&n.pin?t.inputGetState=A(t.inputGetState,n.pin):n.gpioOutput&&n.pin&&(n.getState||"state"===n.output)?t.outputGetState=A(t.outputGetState,n.pin):n.gpioOutput&&n.on&&n.pin?t.outputOn=A(t.outputOn,n.pin):n.gpioOutput&&n.off&&n.pin&&(t.outputOff=A(t.outputOff,n.pin)))}catch(t){e&&e.logEvent("processRequestResourcesData error:",t.message)}}))})),u=!0,t}(n)},stopMonitorAccessRate:C,startMonitorAccessRate:function(e,t){b(l.r),r=!0,setImmediate(F,e)},getDeviceAccessRateData:function(){return S},resetDeviceAccessRateData:function(){S={}}}}},fimLib=exports.fimLib=(t,n)=>{let o=null,r=[],s=[],i=[],a="m2mConfig/",c="m2mConfig/scfg/sconfig",l=!0;function u(e){let n={};try{return n=Buffer.from(JSON.stringify(e)).toString("base64"),fs.writeFileSync(c,n),n}catch(e){return t.logEvent("setSystemConfig error:",e.message),n}}function f(e){let n={};e&&e.path&&(c=e.path);try{n=JSON.parse(Buffer.from(fs.readFileSync(c,"utf8"),"base64").toString())}catch(e){"ENOENT"!==e.code&&t.logEvent("getSystemConfig JSON.parse scpath1 error:",e.message),fs.mkdirSync("m2mConfig/scfg",{recursive:!0})}return n}function m(e,o){try{let r=f();!1===e.enable?(l=!1,r.enable=!1,console.log("disable"),o&&o.stopWatchServices(),n&&n.resources.stopMonitorAccessRate(t),t.logEvent("Endpoint is disabled")):!0===e.enable&&(l=!0,r.enable=!0,console.log("enable"),o&&o.startWatchServices(),n&&o&&n.resources.startMonitorAccessRate(o,t),t.logEvent("Endpoint is enabled")),u(r)}catch(e){t.logEvent("suspend error:",e.message)}}function g(n,o,r,s){try{let i=f();if(i.fim){let a=Object.assign({},spl);a.fim=!0,a._pid="fi-change",a.restartable=t.getRestartStatus(),fs.readFileSync(n),a.filename=t.secTkn.setToBuffer(n,"base64"),a.item={},"af"===o?a.item.af=!0:"sf"===o?a.item.sf=!0:"wf"===o&&(a.item.wf=!0),r&&(a.item.fn=r),s&&(a.result=s),a.stdFim=!0,(i.ar||i.ar1||i.ar2)&&(i.enable=!1,a.enable=!1),a.sconfig=i,socket.send(a),function(n){n||t.logEvent("startActiveResponse error:",e.message),n.ar&&m({enable:!1}),n.ar1&&process.kill(process.pid,"SIGINT"),n.ar2}(i)}}catch(e){e.code,t.logEvent("FimResponse - getSystemConfig error:",e.message)}}function d(e,n,o){try{if(n.length>0)for(let t=0;t<n.length;t++)if(n[t]&&n[t].filename&&e&&n[t].filename===e)return o?void o(null,!0,t):{result:!0,x:t};return!!o&&void o(null,!1)}catch(e){o&&o(e),t.logEvent("findFileName error:",e.message)}}function p(e,n,o){d(e,n,((e,r,s)=>{if(e)throw e;if(r)try{n[s].fileWatcher.close(),n.splice(s,1),o&&o(!0)}catch(e){t.logEvent("closeExtWatchFile - findFileName error:",e.message)}}))}let h=[],y=["node_modules/m2m/lib/endpoint.js","node_modules/m2m/lib/m2m.js","node_modules/node-edge/lib/node-edge.js","node_modules/m2m/lib/supportLib.js"];function v(e){e?h.forEach(((t,n)=>{t.filename===e&&t.watcher.close()})):(h.forEach(((e,t)=>{e.watcher.close(),e.watcher._handle})),h=[])}function E(){o&&o.close()}let S={suspend:m,stopMonEpFS:v,stopMonEpApp:E,startMonEpFS:function(){try{let e=!0;function n(o){try{fs.readFileSync(o);let r=fs.watch(o,{persistent:!1},((r,s)=>{"change"===r&&(e=!1,v(o),g(o,"sf",s),t.logEvent("*unauthorized file system access",o),setTimeout(n,5e3,o))})),s={filename:o,watcher:r},i=!1;setTimeout((()=>{h.forEach(((e,t)=>{e.filename===o&&(e.watcher=r,i=!0)})),!1===i&&h.push(s)}),25)}catch(e){throw"watchNow fs.readFileSync error: "+e}}y.forEach(((e,t)=>{v(e),n(e)}))}catch(o){t.logEvent("startMonEpFS error:",o.message)}},startMonEpApp:function e(n){let r=!0;try{function s(n,o){E(),t.logEvent("*unauthorized ep application code access",n),g(n,"af",o),setTimeout((()=>e(n)),5e3)}fs.readFileSync(n),o=fs.watch(n,{persistent:!1},((e,t)=>{"change"===e&&r&&(r=!1,setImmediate(s,n,t))}))}catch(i){t.logEvent("startMonEpApp fs.readFileSync error:",i.message)}},stopMonExtFile:function(e,n){try{fs.statSync(e),p(e,r,n)}catch(e){t.logEvent("stopMonExtFile error:",e.message)}},closeAllWatcher:function(){r.forEach(((e,t)=>{e.fileWatcher.close()}))},startMonExtFile:function e(n,o){let c=!0,l=null,u=null,f=!1,m=null,h={fileWatcher:"",filename:""},y=1e3,v=Date.now();if("string"==typeof n)u=n,l=v+" "+u;else{if("object"!=typeof n)throw"startMonExtFile - invalid argument";n.filename&&(u=n.filename),n.fn&&(u=n.fn),l=v+" "+u,n.recursive&&"win32"===os.platform()&&(f=n.recursive),n.date&&(l=n.date+" "+u),n.id&&(l=n.id+" "+u)}try{fs.statSync(u)}catch(e){return console.log("startMonExtFile error:",e),function(e,n,o,r,s,i){try{let c="file or directory not found  "+r+" "+e.path;return 1===o[n]?(console.log(e.message,o[n]),o[n]++,s=r+" no such file or directory "+e.path,g(n,"wf",null,s),t.logEvent(c),t.logData(a+"watchLog.txt",c)):(o[n]||(o[n]=1,s=r+" no such file or directory "+e.path,t.logEvent(c),t.logData(a+"watchLog.txt",c)),o[n]++,30===o[n]&&(o[n]=1,s="")),s=r+" no such file or directory "+e.path,setTimeout((()=>g(n,"wf",null,s)),1e4),i?void i(s):s}catch(e){t.logEvent("monExtFileErrorHandler error:",e.message)}}(e.message,u,i,v,l,o)}function E(e){p(u,r,(n=>{try{t.logEvent("*file change detected",l),t.logData(a+"watchLog.txt","*file change detected",l),g(u,"wf",e,l),s[u]=l,o?setImmediate(o,l):(m.close(),setTimeout((()=>{s[u]=""}),y))}catch(e){t.logEvent("fileChangeAlert - closeExtWatchFile error:",e.message)}}))}return function(e,n){let o=d(e,n);if(!o||!o.result)return!1;try{return!0}catch(e){t.logEvent("remove monFile error:",e.message)}}(u,r)?s[u]:(function r(){try{m=fs.watch(u,{persistent:!1,recursive:f},((e,t)=>{"change"===e&&c&&"win32"===os.platform()?(c=!1,setImmediate(E,t)):!c||"rename"!==e&&"change"!==e||(c=!1,setImmediate(E,t))}))}catch(e){e&&t.logEvent("setFileWatcher error:",e.message)}m.on("close",(()=>{setTimeout((()=>{s[u]="",o?e(n,o):r()}),y)})),m.on("node-m2m-error",(e=>{t.logEvent("setFileWatcher error:",e.message)}))}(),h={fileWatcher:m,filename:u},m?(d((S=h).filename,w=r,((e,t,n)=>{if(e)throw e;t?w[n]=S:w.push(S)})),s[u]):void 0);var S,w},getSystemConfig:f,setSystemConfig:u};return S};exports.configLib=function(e,t,n,o,r){let s=!1,i="https://www.node-m2m.com";const a=new RegExp(/\//),c=new RegExp(/\\/);let l=null;function u(t){try{if(t&&"object"!=typeof t)throw new Error("invalid arguments");if(t.m2mConfig&&t.m2mConfig.code&&"object"==typeof t.m2mConfig.code&&t.m2mConfig.code.allow&&t.m2mConfig.code.filename&&t.m2mConfig.code.filename.length>30)throw new Error("code filename is more than the maximum of 30 characters long");if(t.m2mConfig&&t.m2mConfig.code&&"object"!=typeof t.m2mConfig.code)throw new Error("code option must be an object");t.userSettings&&t.userSettings.name&&t.userSettings.name.length>20&&(t.userSettings.name=t.userSettings.name.slice(0,20)),t.userSettings&&t.userSettings.location&&t.userSettings.location.length>20&&(t.userSettings.location=t.userSettings.location.slice(0,20)),t.userSettings&&t.userSettings.description&&t.userSettings.description.length>20&&(t.userSettings.description=t.userSettings.description.slice(0,20))}catch(n){throw e.logEvent("validateUserOptions error:",t,JSON.stringify(n)),n}}function f(){n||(n=fimLib(e,t)),n&&(n.startMonEpFS(),n.startMonEpApp(require.main.filename),e.logEvent("fim enabled - ep app & m2m system file"))}function m(){n&&(n.stopMonEpFS(),n.stopMonEpApp(),e.logEvent("fim disabled - ep app & m2m system file"))}function g(e){return s=e,s}function d(){return s}function p(){return n||(n=fimLib(e,t)),{monFile:n.startMonExtFile,stopMonFile:n.stopMonExtFile,monitorFile:n.startMonExtFile,stopMonitorFile:n.stopMonExtFile}}return{fim:p,setFim:p,defaultNode:i,getPkgConfig:function(e){e.options||(e.options={});try{u(e.options);let t=!1,n=!1,r=!1,s=o.processFilename,i=a.test(s),l=c.test(s);function f(e,t){console.log("\nYou have a misconfigured package.json as shown below:"),console.log(e,t),console.log("\nYou can try fixing it by starting your application with -config flag.\n"),process.exit()}let m=require("../../../package.json");if(m){if(m.m2mConfig&&((l||i)&&(console.log("Your package.json m2mConfig filename is invalid =>",m.m2mConfig),console.log("\nPlease configure your package.json manually for code editing and auto start\n"),process.exit()),m.m2mConfig.code&&!1===m.m2mConfig.code.allow|!0&&m.m2mConfig.code.filename&&m.m2mConfig.code.filename===s&&(e.options.m2mConfig=m.m2mConfig,e.options.processFilename=s,t=!0),t||f("m2mConfig",m.m2mConfig)),m.nodemonConfig&&m.nodemonConfig.watch&&m.nodemonConfig.ignore&&("node_modules/m2m/mon"==m.nodemonConfig.watch[0]&&".git"===m.nodemonConfig.ignore[0]&&"public"===m.nodemonConfig.ignore[1]&&".git"===m.nodemonConfig.ignoreRoot[0]&&"public"===m.nodemonConfig.ignoreRoot[1]&&m.nodemonConfig.execMap.js&&"node"===m.nodemonConfig.execMap.js&&m.nodemonConfig.ext&&"js,json"===m.nodemonConfig.ext&&m.nodemonConfig.delay&&"2000"===m.nodemonConfig.delay&&(e.options.nodemonConfig=!0,n=!0),n||f("nodemonConfig",m.nodemonConfig)),m.scripts){let g={};if(m.scripts.start){e.options.startScript=m.scripts.start;let d=m.scripts.start;g=m.nodemonConfig.delay&&"2000"===m.nodemonConfig.delay?d.match("nodemon "+s):d.match("nodemon --delay 2000ms "+s),g&&g[0]&&(e.options.startScript=g[0],r=!0)}r||f("scripts",m.scripts)}return options&&e.options&&(options=e.options),e.options}}catch(p){p.code}},setPkgConfig:function(t){let n={},r=null,s=null,i=o.processFilename,l=!1,u=!1,f=!1,m=a.test(i),g=c.test(i),d=i.indexOf("/"),p=i.indexOf("\\");try{if(g||m)return console.log("* package.json auto config failed"),void console.log("* Please configure manually your package.json");if(-1!==p||-1!==d)return console.log("** package.json auto config failed"),void console.log("** Please configure manually your package.json");t&&!t.options&&(t.options={}),n=require("../../../package.json"),r=fs.readFileSync("package.orig.json")}catch(e){"MODULE_NOT_FOUND"===e.code&&(n.name="m2m-application",n.version="1.0.0",n.dependencies={m2m:"^"+m2mv.version}),"ENOENT"===e.code&&"package.orig.json"===e.path&&fs.writeFileSync("package.orig.json",JSON.stringify(n,null,2))}finally{try{if(console.log("\nConfiguring your package.json for m2m auto-restart ...\n"),n&&(n.name||(n.name="m2m-application"),n.version||(n.version="1.0.0")),n&&n.dependencies?n.dependencies.m2m="^"+m2mv.version:n.dependencies={m2m:"^"+m2mv.version},n.m2mConfig={code:{allow:!0,filename:i}},t.options.m2mConfig=n.m2mConfig,t.options.processFilename=i,l=!0,n.nodemonConfig={delay:"2000",verbose:!0,restartable:"rs",ignore:[".git","public"],ignoreRoot:[".git","public"],execMap:{js:"node"},watch:["node_modules/m2m/mon"],ext:"js,json"},t.options.nodeConfig=!0,t.options.nodemonConfig=!0,u=!0,s="nodemon "+i,n.scripts={},n.scripts.start=s,t.options.startScript=s,f=!0,fs.writeFileSync("package.json",JSON.stringify(n,null,2)),l&&u&&f){"-config"!==e.argv[0]&&"-cp"!==e.argv[0]||spawnSync("npm i nodemon",{stdio:null,shell:!0});try{require("m2m"),require("nodemon"),e.logEvent("auto-restart package.json configuration - success")}catch(t){console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail")}console.log(colors.brightGreen("Configuration done.")),setImmediate((()=>{n&&console.log("\nPlease verify the changes in your package.json."),r&&console.log("\nYou can revert to your original existing package.json\nusing the backup copy("+colors.brightGreen("package.orig.json")+")."),console.log("\nRestart your application now using",colors.brightGreen("npm start")+".\n"),process.exit()}))}else console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail")}catch(t){e.logEvent("setPkgConfig finally execution error:",arg,t.message)}}},setEpSecPolicy:function(t){try{let e=n.getSystemConfig(t);t.id&&(e.id=t.id),"device"==t.dst&&(e.device=t.dst),"client"==t.dst&&(e.client=t.dst),"user"==t.dst&&(e.user=t.dst),!0!==t.fim&&!1!==t.fim||(e.fim=t.fim,!0===e.fim?(f(),t.result=!0):!1===e.fim&&(e.ea=!1,e.ar=!1,m(),t.result=!0)),!0!==t.ea&&!1!==t.ea||(e.ea=t.ea),!0!==t.ar&&!1!==t.ar||(e.ar=t.ar),!0!==t.zta&&!1!==t.zta||(e.zta=t.zta),e=n.setSystemConfig(e),t.sc=e,setImmediate((()=>{r.emit("ws-emit-send",t)}))}catch(t){e.logEvent("setEpSecPolicy error:",t.message)}},setEnableStatus:g,getEnableStatus:d,executeExitEvent:function(){delete spl.options,delete spl.systemInfo,delete spl.userSettings,delete spl.sconfig,delete spl.ctk,delete spl.tid,delete spl.ak,delete spl.restartable;let t=Object.assign({},spl);t._pid="exit",t.exit=!0,t.active=!1,function(t){let s="exit-process";r.listenerCount(s)<1&&r.once(s,(r=>{!function(t){const r="process exited ("+process.pid+")";e.logEvent(r,"");try{let e=n.getSystemConfig();e.fim&&(t.fim=!0,t.sconfig=e,t.item={af:!0,fn:o.processFilename},t._pid="fi-change"),socket.send(t)}catch(e){console.log("onExitProcess error:",e.message)}}(t)}))}(t),process.on("exit",(()=>{console.log("")})),process.on("SIGINT",(e=>{r.emit("exit-process"),setTimeout((()=>process.exit()),100)}))},getCurrentServer:function(){return i},setCurrentServer:function(e){return e&&"object"==typeof e?e&&e.server&&(i=e.server):e&&"string"==typeof e&&(i=e),e&&(l=e),i},setDefaultSecConfig:function(t){try{let e=n.getSystemConfig();0===Object.keys(e).length&&(e={id:t.id,src:t.src,enable:!0,fim:!1,ea:!1,ar:!1},n.setSystemConfig(e)),t.enable=e.enable,g(e.enable),!1===e.enable&&("v-c"!==t._pid&&"r-d"!==t._pid&&"r-u"!==t._pid||setTimeout((()=>{spl.device||t.device?console.log("\nDevice is disabled\n"):spl.client||t.client?console.log("\nClient is disabled\n"):(spl.user||t.user)&&console.log("\nuser is disabled\n")}),500))}catch(t){e.logEvent("setDefaultSecConfig error:",t.message)}},getUserResources:function(n,o,s){try{if(t||(t=dmLib(e)),n.active=!0,n.enable=d(),n.device&&n.getUserResources)if(n.startAccessRateMonitor){if(t&&s)return t.resources.startMonitorAccessRate(s,e)}else if(n.stopAccessRateMonitor){if(t)return t.resources.stopMonitorAccessRate(e)}else n.getUserResources&&(s&&(s.deviceSetup.id=n.id,n.deviceSetup=s.deviceSetup),t&&(n.deviceTotalAccessRate=t.resources.getDeviceAccessRateData()));else n.client&&n.getUserResources&&t&&o&&(n.clientAccessData=t.resources.getClientAccessData(o));setImmediate((()=>{r.emit("ws-emit-send",n)}))}catch(t){e.logEvent("getUserResources error:",t.message)}},setInitEpSecPolicy:function(t){try{let e=n.getSystemConfig(t);Object.keys(t).length>0&&(!0!==t.fim&&!1!==t.fim||(e.fim=t.fim),!0!==t.ea&&!1!==t.ea||(e.ea=t.ea),!0!==t.ar&&!1!==t.ar||(e.ar=t.ar),!0!==t.zta&&!1!==t.zta||(e.zta=t.zta),e.fim?f():e.fim||m()),n.setSystemConfig(e)}catch(t){e.logEvent("startup setInitEpSecPolicy error:",t.message)}},validateUserOptions:u,getConnectionOptions:function(){return l}}},exports.secLib=function(t,n,o,r,s){const i=[],a=1e6,c={regex:/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})*$/,msg:"Invalid userid. It must follow a valid email format."},l={regex:/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*()\\[\]{}\-_+=~|:;<>,./? ])(?=.{6,})/,msg:"Password must be at least 8 characters long but not over 50 characters long.\nIt must have at least one number, one lowercase letter, one uppercase letter, and one special character."};let u={_sid:"ckm",_pid:null,rk:!0,nodev:process.version,m2mv:m2mv.version,rid:t.rid(4)},f=null,m=5e3,g=15,d={},p={},h=!0,y=t.secTkn.getPtk(),v=t.secTkn.getRtk(),E=t.secTkn.getRpk(),S=null,w=null,b=n.getSystemConfig();function C(){try{return fs.readFileSync(y,"utf8").slice(0,27)}catch(e){"ENOENT"===e.code&&t.secTkn.initSec()}}function k(){let e=null;try{return e=JSON.parse(Buffer.from(fs.readFileSync(C(),"utf8"),"base64").toString("utf8")),e}catch(t){return e}}function x(e,n){try{return fs.writeFileSync(e,n)}catch(e){t.logEvent("setCtk error:",e.message)}}function F(){try{return b.zta&&setTimeout((()=>fs.writeFileSync(y,E)),6e4*g),fs.writeFileSync(y,v)}catch(e){t.logEvent("restoreCtk error:",e.message)}}function A(n){if(t.getRestartStatus())return;let r=null,s=null;try{r=fs.readFileSync("node_modules/m2m/package.json","utf8"),s=fs.readFileSync("node_modules/nodemon/package.json","utf8")}catch(e){t.logEvent("enableAutoRestartConfig fs.readFileSync error:",e.message)}if(!r)return void t.logEvent("enableAutoRestartConfig missing m2m module error:",e.message);let i=Math.floor(5e3*Math.random()+1e3);n.active=!0;try{t.getRestartStatus()?t.getRestartStatus()&&setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","restart")),i):(0===Object.keys(options).length?o.setPkgConfig({}):Object.keys(options).length>0&&(options.m2mConfig&&options.processFilename&&options.nodemonConfig&&options.startScript||o.setPkgConfig({})),r&&!s&&spawnSync(n.cmd[1],n.option[0]),setTimeout((()=>{spawnSync(n.cmd[2],n.option[1])}),i))}catch(e){t.logEvent("enableAutoRestartConfig error:",e.message)}}function O(){return new Date}function D(e){let t="";for(let n=0;n<e;n++)t+="=";return t}"-rs"===processArgs[0]&&processArgs[1]&&(w=parseInt(processArgs[1]),Number.isInteger(w)&&(g=w),w>120&&(g=120)),function(){let e=require.main.filename,t=0;t="win32"===process.platform?e.lastIndexOf("\\"):e.lastIndexOf("/"),S=e.slice(t+1,t+50),s.processFilename=S}();let I=D(60)+"\n"+O()+"\n"+D(60);function T(e,t,n){I=D(60)+"\n"+O()+"\nEndpoint id: "+e.id,fs.appendFileSync(e.filename,I+"\ncommand [ "+e.cli+" ]\n"),setTimeout((()=>{fs.appendFileSync(e.filename,t),e.brCliStore=i,function(e){let t=null;try{t=fs.readFileSync(e.filename,"utf8"),t.length>a&&(t=M(t,e));let n=Buffer.from(t);e.cliLogData=n.toString("base64")}catch(t){L(t,e)}}(e),setImmediate(n,e)}),500)}function N(e){try{"device"===e.dst?e.src="device":"client"===e.dst?e.src="client":"user"===e.dst&&(e.src="user"),e.dst="browser",e.response=!0,e.pl=null,socket.send(e)}catch(e){t.logEvent("processBrCli error:",e.message)}}function R(e,n){let o=!1;try{if(i.length>0)for(let t=0;t<i.length;t++)if(i[t]&&i[t].cmd&&e.cli&&i[t].cliId===e.cliId&&i[t].cmd===e.cli)return o=!0,e.completed=!0,n&&n(!0,t),setTimeout((()=>i.splice(t,1)),100);o||n&&n(!1)}catch(n){setTimeout((()=>{e.result="Command [ "+e.cli+" ] execution error. Please try again later.\n",t.logEvent("removeCliProcess error:",n.message),N(e)}),500)}}function j(e,n){try{let t=Buffer.from(e);n.uploadEventLog?n.eventLogData=t.toString("base64"):(n.uploadCliLog||n.scli)&&(n.cliLogData=t.toString("base64")),n.success=!0}catch(e){n.error="The was an error loading the log file. You can try again later.",t.logEvent("msgBundle error:",e.message)}finally{r.emit("ws-emit-send",n)}}function L(e,n){if("ENOENT"===e.code){let o="Endpoint id: "+n.id+"  -  Log file not found\n";return t.logEvent("logFileError:",o,e.message),j(o,n)}let o="Log file error";return t.logEvent("logFileError:",o,e.message),j(o,n)}function M(e,n){try{let t=I+"\nLog file has reached its max. allowable size.\nFile is truncated ...\n\n"+e.slice(-1e4);return fs.writeFileSync(n.filename,t),t}catch(e){t.logEvent("truncateLogFile error:",e.message)}}function U(e,n){let r=null,s=null;try{r=o.getCurrentServer(),d.v=crypto.createVerify("SHA256"),d.v.update(o.defaultNode),d.v.end(),u._pid=e,u.node=o.defaultNode,f=setTimeout((()=>{console.log("\nThere was no response from the server.\nEither the server is down or you are connecting to an invalid server.\n"),process.kill(process.pid,"SIGINT")}),m)}catch(e){return console.log("getEpCk - node server certificate verification fail:",e.message),void t.logEvent("getEpCk crypto.createVerify error:",JSON.stringify(e))}if(r)try{let e=r.replace("https","wss");s=new _WebSocket(e+"/ckm",{origin:r})}catch(e){t.logEvent("getEpCk (invalid server) server.replace error:",JSON.stringify(e)),console.log("\nInvalid remote server address ...\nPlease confirm if you are connecting to a valid server.\n"),process.kill(process.pid,"SIGINT")}return"dck"===e&&(d.edh=crypto.createECDH("secp521r1"),d.edhpk=d.edh.generateKeys(),u.bk=d.edhpk.toString("base64")),s.on("open",(()=>{1===s.readyState&&s.send(JSON.stringify(u),(e=>{e&&t.logEvent("getEpCk ws open JSON.stringify(rkpl) send error:",JSON.stringify(e))}))})),s.on("error",(e=>{console.log(e),"Unexpected server response: 502"===e.message&&(console.log(colors.yellow("\nRemote server is not responding")," ...\nPlease try again later ...\n"),process.kill(process.pid,"SIGINT"))})),new Promise(((o,r)=>{s.on("message",(r=>{if(clearTimeout(f),1===s.readyState)try{r=JSON.parse(r),"dck"===e&&(d.vrfd=d.v.verify(r.puk,Buffer.from(r.bk,"base64")),d.vrfd&&(n?process.nextTick(n,null,r):o(r)))}catch(e){if(t.logEvent("getEpCk JSON.parse(ck) error:",JSON.stringify(e)),d=null,n)return n(e,null);o(e)}finally{s.close(),setTimeout((()=>r=null),3e3)}}))}))}function _(e,n){try{return e.dpk=n.puk,e.algo="aes-256-gcm",e.rnd=1e4,e.nk=Buffer.from(n.nk,"hex"),e.st=Buffer.from(n.st,"hex"),e.slt1=n.nk,e.slt2=n.st,e.csec=e.edh.computeSecret(Buffer.from(n.sk,"base64")),e.cipkey1=crypto.pbkdf2Sync(e.csec,e.slt1,e.rnd,32,"sha256"),e.cipkey2=crypto.pbkdf2Sync(e.csec,e.slt2,e.rnd,32,"sha256"),e}catch(o){throw t.logEvent("setEncKey error:",JSON.stringify(o)),e=null,n=null,o}}async function P(e,n,o){try{const s=await U("dck");if(d=_(d,s),e)if(d.uc={},d.at={},"string"==typeof e?d.uc=e:"object"==typeof e&&(e.name&&e.password?(d.uc.userid=e.name,d.uc.userpw=e.password,d.uc=JSON.stringify(d.uc)):d.uc=JSON.stringify(e)),"priv"===o){if(!d.cipkey1)throw new Error("invalid private key");d.at.aad=Buffer.from(t.rid(12),"hex"),d.cp=crypto.createCipheriv(d.algo,d.cipkey1,d.nk,{authTagLength:16}),d.cp.setAAD(d.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(d.uc))}),d.uc=d.cp.update(d.uc,"utf8"),d.cp.final(),d.at.tag=d.cp.getAuthTag(),n.euc=d.uc.toString("hex"),n.att=d.at.aad.toString("hex")+d.at.tag.toString("hex")}else{if("pub"!==o)throw new Error("invalid encryption type");if(!d.dpk)throw new Error("invalid public key");n.pd=crypto.publicEncrypt(d.dpk,Buffer.from(d.uc))}if(n.uid=d.slt1,n.idn=d.slt2,e.name&&e.password)return n;r.emit("ws-emit-send",n)}catch(e){throw t.logEvent("encryptData error:",JSON.stringify(e)),e}finally{setTimeout((()=>{d=null,n=null}),2e3)}}async function J(e,n,o,r,s){let i=null,a=null,u=(Math.floor(5e3*Math.random()+1e3),"One of your credentials is invalid");if(n.name&&n.password){if(i=n.name.search(c.regex),a=n.password.search(l.regex),n.name.length<5||n.name.length>50)throw new Error("Userid must be 5 characters minimum and 50 characters maximum.");if(n.password.length<8||n.password.length>50)throw new Error("Password must be 8 characters minimum and 50 characters maximum.");if(0!==i&&0!==a)throw new Error(u)}if(n.sc&&n.sc.length>10)throw new Error(u);n.fe=JSON.stringify({u:n.name,p:n.password,s:n.sc});try{let i=await async function(e,n,o){try{if(e.be)n.be=Buffer.from(e.be).toString("base64"),n.uid=t.rid(8);else if(e.he)n.he=Buffer.from(e.he).toString("hex"),n.uid=t.rid(8);else if(e.fe){const o=await U("dck");d=_(d,o),e.name&&e.password&&(d.uc={},d.at={},d.uc.userid=e.name,d.uc.userpw=e.password,d.at.aad=Buffer.from(t.rid(12),"hex"),d.cp=crypto.createCipheriv(d.algo,d.cipkey1,d.nk,{authTagLength:16}),d.cp.setAAD(d.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(d.uc))}),d.ucs=d.cp.update(JSON.stringify(d.uc),"utf8"),d.cp.final(),d.at.tag=d.cp.getAuthTag(),n.euc=d.ucs.toString("hex"),n.att=d.at.aad.toString("hex")+d.at.tag.toString("hex")),e.sc&&(d.sc={},d.sccp=crypto.createCipheriv(d.algo,d.cipkey2,d.nk,{authTagLength:16}),d.sc.esc=d.sccp.update(e.sc,"utf8"),d.sccp.final(),d.sc.stag=d.sccp.getAuthTag(),n.esc=Buffer.from(JSON.stringify(d.sc),"utf8").toString("hex")),n.uid=d.slt1,n.idn=d.slt2}return n}catch(e){throw t.logEvent("encryptUser (system/process) error:",JSON.stringify(e)),e}finally{setTimeout((()=>{e=null,d=null,n=null}),2e3)}}(n,o);r.connect(e,i,s)}catch(e){throw t.logEvent("authenticate - encryptUser (system) error:",JSON.stringify(e)),"authenticate - encryptUser error"}}function B(e,n,o,r){let s=[];n.client&&"v-c"===n._pid?n._pid="r-c":n.device&&"v-d"===n._pid?n._pid="r-d":n.user&&"v-u"===n._pid&&(n._pid="r-u");const i=e=>!(e.length>10)||"Invalid security code";s.push({type:"input",message:"Enter your userid (email):",name:"name",validate:e=>!(e.search(c.regex)<0)||c.msg}),s.push({type:"password",message:"Enter your password:",name:"password",mask:"*",validate:e=>!(e.search(l.regex)<0)||l.msg}),(n.uid&&"-sc"===processArgs[0]||n.sc)&&(s=[{type:"password",message:"*Enter your security code:",name:"sc",mask:"*",validate:i}],n.vsc=!0,delete n.sc),n.uid&&"-r"!==processArgs[0]&&(s=[{type:"password",message:"Enter your security code:",name:"sc",mask:"*",validate:i}]),console.log("\nPlease provide your credentials ...\n"),inquirer.prompt(s).then((t=>{J(e,t,n,o,r)})).catch((e=>{e.isTtyError?t.logEvent("userPrompt - inquirer error.isTtyError:",JSON.stringify(e)):t.logEvent("userPrompt - inquirer error:",JSON.stringify(e))}))}function q(e,t,n,o){let r={_sid:"m2m"};return r.id=e,r.srcId=e,r[t]=!0,r[n]=r[t],r.src=t,r._pid=o,r.active=!0,r.enable=!0,"device"===t?r.deviceId=e:"client"===t?r.clientId=e:"user"===t?r.userId=e:"endpoint"===t&&(r.endpointId=e),r}function z(e){try{let n=t.rid(4),o=k();if(e&&!e.options&&(e.options={}),e.arg&&"object"==typeof e.arg&&e&&e.options&&(e.options.userSettings=e.arg),e.ep){if(o&&o.ep)return o.options=e.options,e.edgeEp?o.edgeEp=e.edgeEp:e.edgeUser&&(o.edgeUser=e.edgeUser),o;{const t=q(n,"endpoint","e","r-e");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.device){if(e.id!==o.id&&(o=null),o&&o.device)return o.options=e.options,e.edgeEp?o.edgeEp=e.edgeEp:e.edgeUser&&(o.edgeUser=e.edgeUser),o;{const t=q(e.id,"device","d","r-d");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.client){if(o&&o.client)return o.options=e.options,e.edgeEp?o.edgeEp=e.edgeEp:e.edgeUser&&(o.edgeUser=e.edgeUser),o;{const t=q(n,"client","c","r-c");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.user||e.edgeEp||e.edgeUser){if(o&&o.user)return o.options=e.options,o;{const t=q(n,"user","u","r-u");return e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t.options=e.options,t}}}catch(e){console.log("currentEndpoint error:",e.message)}}async function W(e,t,n,o){if("-r"===processArgs[0]&&(t=z(t)),t._sid="m2m",t.tid=Date.now(),e&&"object"==typeof e){if(e.userid&&e.pw&&e.sc){"-r"!==processArgs[0]&&console.log("current user:",e.userid,"\n"),e.trial&&(t.trial=e.trial,t.startDate=Date.now());let r={};return r.name=e.userid,r.password=e.pw,r.sc=e.sc,"-r"===processArgs[0]?B(e,t,n,o):J(e,r,t,n,o)}if(o)return o(new Error("invalid credentials"))}B(e,t,n,o)}return setTimeout((()=>{!function(){let e=Math.floor(5e3*Math.random()+1e3),o="m2m-module-update";r.listenerCount(o)<1&&r.on(o,(o=>{if(o.aid===spl.aid){try{JSON.parse(o.file.package)}catch(e){return void t.logEvent("setModuleUpdateListener JSON.parse(rxd.file.package) error:",e.message)}n&&(n.stopMonEpFS(),n.stopMonEpApp());try{if(!o.path&&!o.file)return;o.file.client&&o.path.client&&fs.writeFileSync(o.path.client,o.file.client),o.file.m2m&&o.path.m2m&&fs.writeFileSync(o.path.m2m,o.file.m2m),o.file.supportLib&&o.path.supportLib&&fs.writeFileSync(o.path.supportLib,o.file.supportLib),o.file.nodeEdge&&o.path.nodeEdge&&fs.writeFileSync(o.path.nodeEdge,o.file.nodeEdge),o.file.package&&o.path.package&&fs.writeFileSync(o.path.package,o.file.package),setImmediate((()=>{o.active=!0,o.update="success",F(),t.getRestartStatus()&&(o.restartable=!0),delete o.file,delete o.code,r.emit("ws-emit-send",o),t.logEvent("m2m module updated","v"+o.ver),o.restartable&&setTimeout((()=>{fs.writeFileSync("node_modules/m2m/mon","m2m module update")}),e)}))}catch(e){t.logEvent("setModuleUpdateListener fs.writeFileSync(path.client, client) error:",e)}}}))}()}),100),{ctk:{setCtk:x,readCtk:k,restoreCtk:F,restartCtk:function(){try{return fs.writeFileSync(y,v)}catch(e){t.logEvent("restartCtk error:",e.message)}}},decSC:function(e,n){if(p&&Object.keys(p).length>0)try{return p.dec=crypto.createCipheriv(p.algo,p.cipkey2,p.nk,{authTagLength:16}),p.decData=p.dec.update(e.edata,"hex","utf8"),p.decData+=p.dec.final("utf8"),n?n(null,p.decData):p.decData}catch(e){if(t.logEvent("decSC error:",JSON.stringify(e)),n)return n(e,null);throw e}finally{setTimeout((()=>{e=null,p=null}),2e3)}},m2mStart:W,m2mRestart:function(e,o,r,s){try{if(o=z(o),n.getSystemConfig().zta)return o.sc=!0,void W(e,o,r,s);if(o.aid&&o.did)return void process.nextTick(r.connect,e,o,s);let i=C(),a=fs.readFileSync(i,"utf8"),c=JSON.parse(Buffer.from(a,"base64").toString("utf8"));setImmediate((()=>{!function(e,n,o,r,s){try{if(console.log("\n"),n.client&&o.id&&"number"==typeof o.id)return console.log("Endpoint has changed from server to client, please register your new client."),W(e,n,r,s);if(n.client&&o.client&&o.clientId&&o.clientId!==n.clientId)return console.log("Client id has changed from",o.id,"to",n.id,"please register your new client."),W(e,n,r,s);if(n.client&&o.user)return console.log("Endpoint has changed from user to client, please register your new client."),W(e,n,r,s);if(n.device&&o.client&&o.id&&"string"==typeof o.id)return console.log("Endpoint has changed from client to server, please register your new server."),W(e,n,r,s);if(n.device&&o.user&&o.id&&"string"==typeof o.id)return console.log("Endpoint has changed from user to server, please register your new server."),W(e,n,r,s);if(n.device&&o.id&&o.id!==n.id)return console.log("Server id has changed from",o.id,"to",n.id,", please register your new server."),W(e,n,r,s);if(n.device&&!o.id)return console.log("Registering new server.\n"),W(e,n,r,s);if(n.user&&(o.device||o.client))return console.log("Endpoint has changed from client/server to user/edge, please register new user/edge."),W(e,n,r,s);if(!(n.device||n.client||n.user||n.endpoint)){if(o.user)return console.log("Register new endpoint.\n"),W(e,n,r,s);console.log("Verifying existing endpoint."),o._pid="r-e"}process.nextTick(r.connect,e,o,s)}catch(e){t.logEvent("validateCtkn error:",JSON.stringify(e))}}(e,o,c,r,s)}))}catch(n){try{let n=fs.readFileSync(t.secTkn.getRtk(),"utf8"),o=JSON.parse(Buffer.from(n,"base64").toString("utf8")),i=Object.assign({},o);W(e,i,r,s)}catch(t){W(e,o,r,s)}}},userPrompt:B,autoRestart:function(e){try{e.device?fs.writeFileSync("node_modules/m2m/mon","restart"):setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","restart")),1e3)}catch(e){t.logEvent("autoRestart error:",e.message)}},rxCommonData:function(e,s,c,l){try{if(e.restart)l&&l.access(e),function(e){try{let s=Math.floor(5e3*Math.random()+1e3);e.active=!0,e.result="fail",e.restartable=!1,e.enable=o.getEnableStatus(),t.getRestartStatus()&&(F(),n&&(n.stopMonEpFS(),n.stopMonEpApp()),e.data&&x(e.path,e.data),e.result="success",e.restartable=!0,t.logEvent("process restarted remotely"),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","restart")),s)),r.emit("ws-emit-send",e)}catch(e){t.logEvent("restartProcess error:",e.message)}}(e);else if(e.status)!function(e,s,a){try{e.options=options,e.systemInfo=t.systemInfo,e.active=!0,e.enable=o.getEnableStatus(),e.containerized=t.systemInfo.container;let c=fs.readFileSync("node_modules/m2m/package.json","utf8"),l=JSON.parse(c);e.systemInfo.m2mv="v"+l.version,e.brCliStore=i;let u=n.getSystemConfig(e);u&&(e.cfg=u),t.getRestartStatus()&&(e.restartable=!0),"client-status"===e._pid?(dm||(dm=dmLib(t)),dm&&s&&(e.clientDeviceId=s.getValidDeviceId(),e.clientAccessData=dm.resources.getClientAccessData(s))):"device-status"===e._pid&&a&&a.deviceSetup&&(e.deviceSetup=a.deviceSetup),setImmediate((()=>{r.emit("ws-emit-send",e)}))}catch(e){t.logEvent("getEndpointStatus error:",e.message)}}(e,s,c);else if(e.secureSystem)!function(e){try{e.active=!0,F(),e.on&&(h=!1),e.result="success",t.logEvent("process","secure system enabled"),r.emit("ws-emit-send",e)}catch(e){t.logEvent("secureSystem error:",e.message)}}(e);else if(e.updateCode)!function(e){e.active=!0;try{if(!e.appData)return e.appData="filename does not exist.",e.error={permission:!0,file:null},r.emit("ws-emit-send",e);if(e.updateCode&&Object.keys(options).length>0&&options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow){if(options.m2mConfig.code.filename){t.getRestartStatus()&&(e.restartable=!0),n&&n.stopMonEpApp();let o=Buffer.from(e.appData,"base64").toString("utf8");return!1===o.includes("require('m2m')",0)?void t.logEvent("updateCode error:remote browser app code is not in utf8 format"):fs.writeFile(options.m2mConfig.code.filename,o,(o=>{if(o)return"ENOENT"===o.code?e.appData="filename does not exist.":e.appData=o,t.logEvent("application code update error:",o.message),e.error={permission:!0,file:null},r.emit("ws-emit-send",e);delete e.appData,e.success=!0,r.emit("ws-emit-send",e),n&&n.startMonEpApp(options.m2mConfig.code.filename),F(),t.logEvent("application code updated",options.m2mConfig.code.filename),setImmediate((()=>{fs.writeFileSync("node_modules/m2m/mon","code-update")}))}))}return e.error={permission:!0,file:null},t.logEvent("updateCode missing filename error:",options.m2mConfig),r.emit("ws-emit-send",e)}e.error={permission:!1},t.logEvent("updateCode missing options.m2mConfig.code error:",options),r.emit("ws-emit-send",e)}catch(e){t.logEvent("updateCode error:",e.message)}}(e);else if(e.uploadCode)!function(e){e.active=!0;try{if(e.uploadCode&&Object.keys(options).length>0)return options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow&&options.m2mConfig.code.filename?(e.processFilename=options.m2mConfig.code.filename,function(e,n){let s=o.getConnectionOptions();fs.readFile(e,"utf8",((e,o)=>{try{if(e)return"ENOENT"===e.code?n.appData="filename does not exist.":n.appData=e,n.error={permission:!1,file:null},r.emit("ws-emit-send",n);let t=Buffer.from(o);if(s&&s.pw)return n.error={pw:!0,permission:!1,file:null},r.emit("ws-emit-send",n);n.success=!0,F(),n.enc?P(o,n,"priv"):(n.appData=t.toString("base64"),r.emit("ws-emit-send",n))}catch(e){t.logEvent("getCodeData error:",e.message)}}))}(options.m2mConfig.code.filename,e)):(e.error={permission:!0,file:null},r.emit("ws-emit-send",e));e.error={permission:!1},r.emit("ws-emit-send",e)}catch(e){t.logEvent("uploadCode error:",e.message)}}(e);else if(e.uploadCliLog)!function(e){e.active=!0,e.uploadCliLog&&function(e){try{let t=fs.readFileSync(e.filename,"utf8");if(t.length>a)return j(M(t,e),e);if(e.enc)return P(t,e,"priv");j(t,e)}catch(t){L(t,e)}}(e)}(e);else if(e.clearCliLog)!function(e){e.active=!0;try{t.rid(4),fs.readFileSync(e.filename,"utf8"),setTimeout((()=>{(e.clearCliLog||e.clearEventLog)&&function(e){let n="";e.clearEventLog&&(n=t.eventLogHeader);try{fs.writeFileSync(e.filename,n),e.success=!0,r.emit("ws-emit-send",e)}catch(t){return L(t,e)}}(e)}),300)}catch(n){t.logEvent("clearLogFile error:",n.message),e.error="Cannot clear log file",r.emit("ws-emit-send",e)}}(e);else if(e.acli)!function(e){e.success=!0,R(e,((n,o)=>{try{n?(i[o].cli.kill("SIGSTOP"),i[o].cli.killed?T(e,"Aborted\n\n",N):T(e,"Abort fail\n\n",N)):T(e,"Already executed, nothing to abort\n\n",N)}catch(e){t.logEvent("aCli error:",e.message)}}))}(e);else if(e.scli){if(e.ers)return l&&l.access(e),F(),void A(e);!function(e){try{if(e.ers)return F(),A(e);!function(e,n,o){let r=null,s="",a=null;try{e.opt&&(a=e.opt);let c=spawn(n,{stdio:a,shell:!0}),l={cli:c,cmd:e.cli,pid:c.pid,killed:c.killed,cliId:e.cliId};i.push(l),n=null,e.success=!0,"win32"!==process.platform&&(r=setTimeout((()=>{s+=e.crp,R(e),T(e,s+"\n",o)}),3e3),c.stdout.on("data",(e=>{s+=e.toString(),clearTimeout(r)})),c.stderr.on("data",(e=>{let t=e.toString().search("no password was provided"),n=e.toString().search("password for");-1===t&&-1===n&&(s+=e.toString())}))),c.on("close",((t,n)=>{clearTimeout(r),n&&(s+="Command aborted\n"),e.code=t,R(e),T(e,s+"\n",o)})),c.on("exit",((e,t)=>{})),c.on("node-m2m-error",(n=>{t.logEvent("cli execution error:",n.toString()),T(e,s+"error: "+n.toString()+"\n",o)})),c.stdin.end()}catch(n){t.logEvent("exeBrCli error:",n.message),T(e,"Execution error. Please try again later.\n\n",o)}}(e,Buffer.from(e.pl,"base64").toString("utf8"),(e=>{N(e)}))}catch(e){t.logEvent("eCli error:",e.message)}}(e)}else e.setEpSec?o.setEpSecPolicy(e):e.suspend?n.suspend(e,c):e.getUserResources||e.startAccessRateMonitor||e.stopAccessRateMonitor?o.getUserResources(e,s,c):e.edgeResources?l&&l.resources(e):e.accessEdge&&l&&l.access(e)}catch(e){t.logEvent("rxCommonData error:",e.message)}},getCurrentProcessName:function(){return S}}};
