/*!
 * supportLib.js
 * v2.4.2
 *
 * Copyright(c) 2020 Ed Alegrid
 *
 */
"use strict";const _WebSocket=require("ws"),colors=require("colors"),inquirer=require("inquirer"),m2mv=require("../package.json"),fs=require("fs"),os=require("os"),ip=require("ip"),crypto=require("crypto"),{spawn:spawn,spawnSync:spawnSync,execFileSync:execFileSync}=require("child_process"),{match:match}=require("assert"),processArgs=process.argv.slice(2);let spl={},socket=null,options={};exports.setLibDefaults=function(e,t){e&&(spl=e),t&&(socket=t)};try{fs.readFileSync("./node_modules/m2m/package.json")}catch(e){console.log(colors.brightYellow("\nM2M Module Warning!")),console.log("Cannot find/resolve the node.js node_modules directory inside the project's root directory."),console.log("Please configure/install the node_modules inside of the root directory.\n")}exports.m2mUtilLib=function(e){const t=/^[A-Za-z0-9-_\/]*$/,n=/^[A-Za-z0-9 \[\]"{}':,._-]*$/;let r=null,o="m2mConfig/sec/",s=o+"ptk",i=o+"tk",a=o+"pk",c=process.pid,l=null,f=null,m=!1,u="m2mConfig/eLog",g=35e3,d="                  Date                                           Event";function p(e,t){fs.mkdir("m2mConfig/",(n=>{try{if(n)throw n;e?fs.writeFileSync(e,d):fs.writeFileSync(u,d),t&&t()}catch(e){if("EEXIST"!==e.code)throw console.log("initLog error:",n.message),e.message}}))}function h(e,t,n,r,o,s,i,a,c,l){try{o||(o=""),s||(s=""),i||(i=""),a||(a=""),c||(c=""),l||(l=""),function(e,t,n,r,o,s,i,a,c,l){fs.open(e,"r",((t,f)=>{t&&"ENOENT"===t.code&&fs.writeFileSync(e,d);try{fs.appendFileSync(e,"\n"+n+"  "+r+"  "+o+"  "+s+"  "+i+"  "+a+"  "+c+"  "+l)}catch(t){throw t}})),fs.stat(e,((f,m)=>{if(f&&"ENOENT"===f.code&&p(),m&&m.size>t)try{fs.writeFileSync(e,d),fs.appendFileSync(e,"\n"+n+"  "+r+"  "+o+"  "+s+"  "+i+"  "+a+"  "+c+"  "+l)}catch(f){throw f}}))}(e,t,n,r,o,s,i,a,c,l)}catch(e){throw e}}function y(e,t,n,r,o,s,i){let a=new Date,c=a.toDateString()+" "+a.toLocaleTimeString();h(u,g,c,e,t,n,r,o,s,i)}function v(){fs.mkdir(o,(e=>{e||function(){try{fs.writeFileSync(s,i),fs.writeFileSync(a,"node-m2m")}catch(e){y("setSecTk - fs.writeFileSync error:",e.message)}}()}))}m=!("start"!==process.env.npm_lifecycle_event&&!process.env.npm_package_nodemonConfig_restartable),p(),y("process starting pid","("+process.pid+")"),v(),r="linux"===os.platform()?execFileSync("npm",["-v"]):"win32"===os.platform()?execFileSync("npm -v",{shell:!0}):execFileSync("npm",["-v"]);const S={nodev:process.version,npmv:r.toString("utf8"),type:os.arch(),mem:{total:(os.totalmem()/1e6).toFixed(0)+" MB",free:(os.freemem()/1e6).toFixed(0)+" MB"},m2mv:"v"+m2mv.version,os:os.platform(),container:function(){try{return!(c.toString().length>1||(y("process running in container",!0),0))}catch(e){y("isContainer error:",e.message)}}(),ip:ip.address()};function E(){return l=new Date,l}return E(),{st:E,et:function(){return f=new Date,f-l+" ms"},rid:function(e){return crypto.randomBytes(e).toString("hex")},secTkn:{getPtk:function(){return s},getRtk:function(){return i},getRpk:function(){return a},initSec:v,setToBuffer:function(e,t){try{if("base64"===t)return Buffer.from(JSON.stringify(e)).toString("base64");if("hex"===t)return Buffer.from(JSON.stringify(e)).toString("hex")}catch(e){y("setToBuffer error:",e.message)}}},m2mInfo:function(e,t){try{console.log("\n**************************************"),console.log("   m2m ver:",m2mv.version),console.log("   os:",process.platform),console.log("   h/w type:",os.arch()),e.server?(console.log("   endpoint: server"),e.id&&console.log("   id:",e.id)):e.client?(console.log("   endpoint: client"),e.clientId&&console.log("   id:",e.clientId)):e.edgeUser&&e.user?(console.log("   endpoint: edge (user)"),e.userId&&console.log("   id:",e.userId)):e.user&&!e.edgeUser&&(console.log("   endpoint: user"),e.userId&&console.log("   id:",e.userId)),console.log("   node-m2m -server:",colors.brightBlue(t),"\n**************************************")}catch(e){y("m2mInfo error:",e.message)}},logData:function(e,t,n,r,o,s,i,a){let c=new Date,l=c.toDateString()+" "+c.toLocaleTimeString();h(e,g,l,t,n,r,o,s,i,a)},logEvent:y,setError:function(t,n,r){let o=new Error(t);if(y("error:",o.message),e.emit("node-m2m-error",o),n)n({error:o.message});else{if(!r)throw o;r(o)}},systemInfo:S,getUrlKeys:function(e,t){let n=null;const r=[],o=[],s={};t.startsWith("/")||m2mUtil.setError(new Error("path: "+e.name+" - invalid url path, it must begin with a slash /"),null,null);let i=t.indexOf("?",1);-1!==i&&(n=t.substring(i+1,t.length)),new URLSearchParams(n).forEach((function(e,t){s[t]=e}));let a=t.indexOf("?");-1!==a&&(t=t.slice(0,a));for(let e=0;e<t.length;e++)"/"===t[e]&&r.push(e);return r.forEach(((e,n)=>{try{if(0==e&&r[n+1]){let e=t.slice(r[n],r[n+1]);o.push(e)}else if(0!==e&&r[n]&&r[n+1]){let e=t.slice(r[n],r[n+1]);o.push(e)}else{let e=t.slice(r[n],t.length);o.push(e)}}catch(e){m2mUtil.logEvent("urlRoutesIndex.forEach error:",e.message)}})),e.urlPathKeys=o,e.baseUrl=o[0],e.query=s,e},getSubTopic:function(e,t){const n=[],r=[];if(!t.startsWith("/"))return e;if(t.includes("?"))throw t+" - invalid topic attribute";for(let e=0;e<t.length;e++)("/"===t[e]||"#"===t[e])&&n.push(e);n.forEach((function(e,o){if(0===e&&n[o+1]){let e=t.slice(n[o],n[o+1]);r.push(e)}else if(0!==e&&n[o]&&n[o+1]){let e=t.slice(n[o],n[o+1]);r.push(e)}else{let e=t.slice(n[o],t.length);r.push(e)}}));let o={};r[0]===t&&1===r.length&&(o.root=r[0]);let s=r[0].length,i=t.slice(s);return e.topicKeys=r,e.baseTopic=r[0],e.subTopic=i,e.rootTopic=o.root,e},getParamKeys:function(e){const t={},n=[],r=[],o={},s=[];for(let t=0;t<e.length;t++)"/"===e[t]&&n.push(t);return n.forEach(((t,o)=>{if(0==t&&n[o+1]){let t=e.slice(n[o],n[o+1]);r.push(t)}else if(0!==t&&n[o]&&n[o+1]){let t=e.slice(n[o],n[o+1]);r.push(t)}else{let t=e.slice(n[o],e.length);r.push(t)}})),r.forEach(((e,t)=>{if(e.startsWith("/:")){let n=e.slice(2,e.length),r={key:n,index:t};o[n]=n,s.push(r)}})),t.urlPathKeys=r,t.baseUrl=r[0],t.params=o,t.paramKeys=s,t.rootPath=r[0],t},startConnect:function(t,n){let r="emit-connect";t&&t.resetServerSetup(),e.listenerCount(r)<1&&e.on(r,(e=>{if(n||console.log(e),n)if(n.length>0){if(Array.isArray(e))return n("registration fail");setImmediate(n,e)}else{if(Array.isArray(e))return console.log("registration fail");console.log("connection:",e),setImmediate(n)}}))},setDataEvent:function(e,t){try{if(t.length>0)for(let n=0;n<t.length;n++)if(t[n]&&e.name&&e.event&&t[n].id===e.id&&t[n].name===e.name)return!0;return t.push(e),!1}catch(e){y("setDataEvent error:",e.message)}},eventLogHeader:d,getRestartStatus:function(){return m},setEpErrorEvent:function(t,n){if("error"!==t)throw new Error(t+" event name is invalid");let r="node-m2m-"+t;e.listenerCount(r)<1&&e.on(r,(e=>{if("object"==typeof e)return n(e);"string"==typeof e&&n(e)}))},argv:processArgs,validateNameAndPayload:function(e){let r=!0,o=null,s=null;try{if(!e)return void y("validateNameAndPayload !arg:",JSON.stringify(e));if(Array.isArray(e)&&(s=e[0]),s&&(e=s),e.name&&("string"!=typeof e.name&&(r=null),e.name.length>75&&(r=null),e.name.match(t),!r))throw new Error("invalid channel/path");if((e.payload||e.body)&&(e.payload?o=e.payload:e.body&&(o=e.body),"number"==typeof o||"object"==typeof o||"string"==typeof o||(r=null)),o&&(o=JSON.stringify(o),o&&o.length>500&&(r=null),o&&o.match(n),!r))throw e.payload&&(e.payload=null,y("write/sendData - invalid payload data",o)),e.body&&(e.body=null,y("post - invalid body data",o)),new Error("invalid payload/body");return r}catch(e){throw y("validateNameAndPayload error:",e.message),e}},removeDuplicateInArray:function(e){return Array.from(new Set(e))},validateClientApi:function(e,t,n,r,o,s,i,a){let c={};if("string"==typeof e&&o&&("function"==typeof t&&(i=t,"watch"===s&&(r=5e3)),"function"==typeof n&&(i=n),"function"==typeof r&&(i=r,Number.isInteger(t)&&(r=t)),"write"!==s&&"sendData"!==s&&"post"!==s||(n=t),t=e,e=o),Number.isInteger(e)?(c.id=e,"string"==typeof t&&("get"===s||"post"===s?c.path=t:c.channel=t),"number"!=typeof n&&"string"!=typeof n&&"object"!=typeof n||("post"===s?c.body=n:"write"!==s&&"sendData"!==s||(c.payload=n)),"function"==typeof r&&(i=r,r=5e3),Number.isInteger(r)&&(c.interval=r)):"object"==typeof e&&(i=t,o&&(e.id=o),"watch"===s&&(e.interval||(e.interval=5e3)),"function"==typeof t&&(i=t),c=e),!c.id)throw console.log(c),new Error("validateClientApi error - missing id");if("get"===s||"post"===s){if(!c.path)throw console.log(c),new Error("validateClientApi error - missing path")}else if(c.topic);else if(!c.channel)throw console.log(c),new Error("validateClientApi error - missing channel");if("post"===s){if(!c.body)throw console.log(c),new Error("validateClientApi error - missing body")}else if(("write"===s||"sendData"===s)&&!c.payload)throw console.log(c),new Error("validateClientApi error - missing payload");if("watch"===s&&!c.interval)throw console.log(c),new Error("validateClientApi error - missing interval");return new Promise((function(e,t){"function"==typeof i&&(e=null,t=null),a(c,s,i,e,t)}))},removeDuplicateObjectInArray:e=>{if(!Array.isArray(e))return y("filterArray invalid array input:",""+e),!1;try{return e.filter(((t,n)=>n===e.findIndex((e=>t.title===e.title))))}catch(e){y("filterArray error:",e.message)}}}};const dmLib=exports.dmLib=e=>{let t=[],n=1,r={},o=!0,s=6e4,i=null,a=1,c=60,l={r:"r",w:"w"},f=!1,m=[],u=[],g=[],d=[],p=[],h=[],y=[],v=[],S=[],E={},w=[];function b(e,t){let n="m2mConfig/ar",r="base64",o="utf8";try{if("r"===e){let e=fs.readFileSync(n,"utf8");e&&(E=JSON.parse(Buffer.from(e,r).toString(o)))}else if("w"===e&&Object.keys(E).length>0&&E.accessRateData&&E.accessRateData[0]){let e=JSON.stringify(E),t=Buffer.from(e,o).toString(r);fs.writeFileSync(n,t)}}catch(e){}}function C(e){a=1,o=!1,m=[],u=[],g=[],d=[],p=[],h=[],y=[],v=[],S=[],E={},E.accessCounter=1,E.monStatus=!1,clearTimeout(i)}function k(e,t){e.forEach(((e,n)=>{let r={id:spl.id,name:e,cpm:0,tcpm:0,arpm:0};t.push(r)}))}function F(e){e.forEach(((e,t)=>{e.tcpm=e.tcpm+e.cpm,e.arpm=(e.tcpm/a).toFixed(n),e.iteration=a;let r=Object.assign({},e);e.tcpm&&S.push(r),e.cpm=0}))}function x(t){o=!0,E.monStatus=!0,t&&(r=t.resources.getserverResources());let n=r.publish.name,f=r.dataSource.name,A=r.get.path,O=r.post.path;1===a&&(k(n,m),k(f,u),k(A,g),k(O,d)),S=[],i=setTimeout((()=>{o=!1,clearTimeout(i),w.forEach(((t,n)=>{try{t.name&&t.watch&&"watch"===t.method?m.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.watch=!0)})):t.name&&t.getData&&"getData"===t.method?u.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.getData=!0)})):t.name&&t.sendData&&"sendData"===t.method?u.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.sendData=!0)})):t.name&&t.read&&"read"===t.method?u.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.read=!0)})):t.name&&t.write&&"write"===t.method?u.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.write=!0)})):t.name&&t.get&&"get"===t.method?g.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.get=!0)})):t.name&&t.post&&"post"===t.method&&d.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.post=!0)}))}catch(t){e&&e.logEvent("accessRateMonitoring error:",t.message)}})),F(m),F(u),F(g),F(d),F(p),F(h),F(y),F(v),setImmediate((()=>{E={accessRateData:S,monStatus:!0,accessCounter:a},w=[],setTimeout((()=>{a<c?(b(l.w),a++,x(t)):(C(),b(l.w),setTimeout((()=>{x(t)}),25))}),1e3)}))}),s)}function A(t,n){return t.push("&nbsp"+n),e.removeDuplicateInArray(t)}return{resources:{collectAccessData:function(e){o&&w.push(e)},getClientAccessData:function(n){return f?t:function(n){let r=function(e){let t=[],n=e.getValidServers();return e.getClientRawAccessData().forEach((e=>{n.includes(e.id)&&t.push(e)})),t}(n);return r.forEach((n=>function(n){let r=!1,o=e.systemInfo.ip,s={id:n.id,clientId:n.clientId,ip:o,sub:[],read:[],write:[],get:[],post:[],inputGetState:[],inputWatch:[],outputGetState:[],outputOn:[],outputOff:[]};t.forEach(((e,t)=>{e.id===n.id&&(r=!0)})),!1===r&&t.push(s)}(n))),t.forEach(((t,n)=>{r.forEach(((n,r)=>{try{t.id===n.id&&(n.getData&&n.name?t.read=A(t.read,n.name):n.sendData&&n.name?t.write=A(t.write,n.name):n.read&&n.name?t.read=A(t.read,n.name):n.write&&n.name?t.write=A(t.write,n.name):n.watch&&n.name?t.sub=A(t.sub,n.name):n.get&&n.name?t.get=A(t.get,n.name):n.post&&n.name?t.post=A(t.post,n.name):n.gpioInput&&n.watch&&n.pin?t.inputWatch=A(t.inputWatch,n.pin):n.gpioInput&&n.getState&&n.pin?t.inputGetState=A(t.inputGetState,n.pin):n.gpioOutput&&n.pin&&(n.getState||"state"===n.output)?t.outputGetState=A(t.outputGetState,n.pin):n.gpioOutput&&n.on&&n.pin?t.outputOn=A(t.outputOn,n.pin):n.gpioOutput&&n.off&&n.pin&&(t.outputOff=A(t.outputOff,n.pin)))}catch(t){e&&e.logEvent("processRequestResourcesData error:",t.message)}}))})),f=!0,t}(n)},stopMonitorAccessRate:C,startMonitorAccessRate:function(e,t){b(l.r),o=!0,setImmediate(x,e)},getserverAccessRateData:function(){return E},resetserverAccessRateData:function(){E={}}}}},fimLib=exports.fimLib=(t,n)=>{let r=null,o=[],s=[],i=[],a="m2mConfig/",c="m2mConfig/scfg/sconfig",l=!0;function f(e){let n={};try{return n=Buffer.from(JSON.stringify(e)).toString("base64"),fs.writeFileSync(c,n),n}catch(e){return t.logEvent("setSystemConfig error:",e.message),n}}function m(e){let n={};e&&e.path&&(c=e.path);try{n=JSON.parse(Buffer.from(fs.readFileSync(c,"utf8"),"base64").toString())}catch(e){"ENOENT"!==e.code&&t.logEvent("getSystemConfig JSON.parse scpath1 error:",e.message),fs.mkdirSync("m2mConfig/scfg",{recursive:!0})}return n}function u(e,r){try{let o=m();!1===e.enable?(l=!1,o.enable=!1,console.log("disable"),r&&r.stopWatchServices(),n&&n.resources.stopMonitorAccessRate(t),t.logEvent("Endpoint is disabled")):!0===e.enable&&(l=!0,o.enable=!0,console.log("enable"),r&&r.startWatchServices(),n&&r&&n.resources.startMonitorAccessRate(r,t),t.logEvent("Endpoint is enabled")),f(o)}catch(e){t.logEvent("suspend error:",e.message)}}function g(n,r,o,s){try{let i=m();if(i.fim){let a=Object.assign({},spl);a.fim=!0,a._pid="fi-change",a.restartable=t.getRestartStatus(),fs.readFileSync(n),a.filename=t.secTkn.setToBuffer(n,"base64"),a.item={},"af"===r?a.item.af=!0:"sf"===r?a.item.sf=!0:"wf"===r&&(a.item.wf=!0),o&&(a.item.fn=o),s&&(a.result=s),a.stdFim=!0,(i.ar||i.ar1||i.ar2)&&(i.enable=!1,a.enable=!1),a.sconfig=i,socket.send(a),function(n){n||t.logEvent("startActiveResponse error:",e.message),n.ar&&u({enable:!1}),n.ar1&&process.kill(process.pid,"SIGINT"),n.ar2}(i)}}catch(e){e.code,t.logEvent("FimResponse - getSystemConfig error:",e.message)}}function d(e,n,r){try{if(n.length>0)for(let t=0;t<n.length;t++)if(n[t]&&n[t].filename&&e&&n[t].filename===e)return r?void r(null,!0,t):{result:!0,x:t};return!!r&&void r(null,!1)}catch(e){r&&r(e),t.logEvent("findFileName error:",e.message)}}function p(e,n,r){d(e,n,((e,o,s)=>{if(e)throw e;if(o)try{n[s].fileWatcher.close(),n.splice(s,1),r&&r(!0)}catch(e){t.logEvent("closeExtWatchFile - findFileName error:",e.message)}}))}let h=[],y=["node_modules/m2m/lib/endpoint.js","node_modules/m2m/lib/m2m.js","node_modules/node-edge/lib/node-edge.js","node_modules/m2m/lib/supportLib.js"];function v(e){e?h.forEach(((t,n)=>{t.filename===e&&t.watcher.close()})):(h.forEach(((e,t)=>{e.watcher.close(),e.watcher._handle})),h=[])}function S(){r&&r.close()}let E={suspend:u,stopMonEpFS:v,stopMonEpApp:S,startMonEpFS:function(){try{let e=!0;function n(r){try{fs.readFileSync(r);let o=fs.watch(r,{persistent:!1},((o,s)=>{"change"===o&&(e=!1,v(r),g(r,"sf",s),t.logEvent("*unauthorized file system access",r),setTimeout(n,5e3,r))})),s={filename:r,watcher:o},i=!1;setTimeout((()=>{h.forEach(((e,t)=>{e.filename===r&&(e.watcher=o,i=!0)})),!1===i&&h.push(s)}),25)}catch(e){throw"watchNow fs.readFileSync error: "+e}}y.forEach(((e,t)=>{v(e),n(e)}))}catch(r){t.logEvent("startMonEpFS error:",r.message)}},startMonEpApp:function e(n){let o=!0;try{function s(n,r){S(),t.logEvent("*unauthorized ep application code access",n),g(n,"af",r),setTimeout((()=>e(n)),5e3)}fs.readFileSync(n),r=fs.watch(n,{persistent:!1},((e,t)=>{"change"===e&&o&&(o=!1,setImmediate(s,n,t))}))}catch(i){t.logEvent("startMonEpApp fs.readFileSync error:",i.message)}},stopMonExtFile:function(e,n){try{fs.statSync(e),p(e,o,n)}catch(e){t.logEvent("stopMonExtFile error:",e.message)}},closeAllWatcher:function(){o.forEach(((e,t)=>{e.fileWatcher.close()}))},startMonExtFile:function e(n,r){let c=!0,l=null,f=null,m=!1,u=null,h={fileWatcher:"",filename:""},y=1e3,v=Date.now();if("string"==typeof n)f=n,l=v+" "+f;else{if("object"!=typeof n)throw"startMonExtFile - invalid argument";n.filename&&(f=n.filename),n.fn&&(f=n.fn),l=v+" "+f,n.recursive&&"win32"===os.platform()&&(m=n.recursive),n.date&&(l=n.date+" "+f),n.id&&(l=n.id+" "+f)}try{fs.statSync(f)}catch(e){return console.log("startMonExtFile error:",e),function(e,n,r,o,s,i){try{let c="file or directory not found  "+o+" "+e.path;return 1===r[n]?(console.log(e.message,r[n]),r[n]++,s=o+" no such file or directory "+e.path,g(n,"wf",null,s),t.logEvent(c),t.logData(a+"watchLog.txt",c)):(r[n]||(r[n]=1,s=o+" no such file or directory "+e.path,t.logEvent(c),t.logData(a+"watchLog.txt",c)),r[n]++,30===r[n]&&(r[n]=1,s="")),s=o+" no such file or directory "+e.path,setTimeout((()=>g(n,"wf",null,s)),1e4),i?void i(s):s}catch(e){t.logEvent("monExtFileErrorHandler error:",e.message)}}(e.message,f,i,v,l,r)}function S(e){p(f,o,(n=>{try{t.logEvent("*file change detected",l),t.logData(a+"watchLog.txt","*file change detected",l),g(f,"wf",e,l),s[f]=l,r?setImmediate(r,l):(u.close(),setTimeout((()=>{s[f]=""}),y))}catch(e){t.logEvent("fileChangeAlert - closeExtWatchFile error:",e.message)}}))}return function(e,n){let r=d(e,n);if(!r||!r.result)return!1;try{return!0}catch(e){t.logEvent("remove monFile error:",e.message)}}(f,o)?s[f]:(function o(){try{u=fs.watch(f,{persistent:!1,recursive:m},((e,t)=>{"change"===e&&c&&"win32"===os.platform()?(c=!1,setImmediate(S,t)):!c||"rename"!==e&&"change"!==e||(c=!1,setImmediate(S,t))}))}catch(e){e&&t.logEvent("setFileWatcher error:",e.message)}u.on("close",(()=>{setTimeout((()=>{s[f]="",r?e(n,r):o()}),y)})),u.on("node-m2m-error",(e=>{t.logEvent("setFileWatcher error:",e.message)}))}(),h={fileWatcher:u,filename:f},u?(d((E=h).filename,w=o,((e,t,n)=>{if(e)throw e;t?w[n]=E:w.push(E)})),s[f]):void 0);var E,w},getSystemConfig:m,setSystemConfig:f};return E};exports.configLib=function(e,t,n,r,o){let s=!1,i="https://www.node-m2m.com";const a=new RegExp(/\//),c=new RegExp(/\\/);let l=null;function f(t){try{if(t&&"object"!=typeof t)throw new Error("invalid arguments");if(t.m2mConfig&&t.m2mConfig.code&&"object"==typeof t.m2mConfig.code&&t.m2mConfig.code.allow&&t.m2mConfig.code.filename&&t.m2mConfig.code.filename.length>30)throw new Error("code filename is more than the maximum of 30 characters long");if(t.m2mConfig&&t.m2mConfig.code&&"object"!=typeof t.m2mConfig.code)throw new Error("code option must be an object");t.userSettings&&t.userSettings.name&&t.userSettings.name.length>20&&(t.userSettings.name=t.userSettings.name.slice(0,20)),t.userSettings&&t.userSettings.location&&t.userSettings.location.length>20&&(t.userSettings.location=t.userSettings.location.slice(0,20)),t.userSettings&&t.userSettings.description&&t.userSettings.description.length>20&&(t.userSettings.description=t.userSettings.description.slice(0,20))}catch(n){throw e.logEvent("validateUserOptions error:",t,JSON.stringify(n)),n}}function m(){n||(n=fimLib(e,t)),n&&(n.startMonEpFS(),n.startMonEpApp(require.main.filename),e.logEvent("fim enabled - ep app & m2m system file"))}function u(){n&&(n.stopMonEpFS(),n.stopMonEpApp(),e.logEvent("fim disabled - ep app & m2m system file"))}function g(e){return s=e,s}function d(){return s}function p(){return n||(n=fimLib(e,t)),{monFile:n.startMonExtFile,stopMonFile:n.stopMonExtFile,monitorFile:n.startMonExtFile,stopMonitorFile:n.stopMonExtFile}}return{fim:p,setFim:p,defaultNode:i,getPkgConfig:function(e){e.options||(e.options={});try{f(e.options);let t=!1,n=!1,o=!1,s=r.processFilename,i=a.test(s),l=c.test(s);function m(e,t){console.log("\nYou have a misconfigured package.json as shown below:"),console.log(e,t),console.log("\nYou can try fixing it by starting your application with -config flag.\n"),process.exit()}let u=require("../../../package.json");if(u){if(u.m2mConfig&&((l||i)&&(console.log("Your package.json m2mConfig filename is invalid =>",u.m2mConfig),console.log("\nPlease configure your package.json manually for code editing and auto start\n"),process.exit()),u.m2mConfig.code&&!1===u.m2mConfig.code.allow|!0&&u.m2mConfig.code.filename&&u.m2mConfig.code.filename===s&&(e.options.m2mConfig=u.m2mConfig,e.options.processFilename=s,t=!0),t||m("m2mConfig",u.m2mConfig)),u.nodemonConfig&&u.nodemonConfig.watch&&u.nodemonConfig.ignore&&("node_modules/m2m/mon"==u.nodemonConfig.watch[0]&&".git"===u.nodemonConfig.ignore[0]&&"public"===u.nodemonConfig.ignore[1]&&".git"===u.nodemonConfig.ignoreRoot[0]&&"public"===u.nodemonConfig.ignoreRoot[1]&&u.nodemonConfig.execMap.js&&"node"===u.nodemonConfig.execMap.js&&u.nodemonConfig.ext&&"js,json"===u.nodemonConfig.ext&&u.nodemonConfig.delay&&"2000"===u.nodemonConfig.delay&&(e.options.nodemonConfig=!0,n=!0),n||m("nodemonConfig",u.nodemonConfig)),u.scripts){let g={};if(u.scripts.start){e.options.startScript=u.scripts.start;let d=u.scripts.start;g=u.nodemonConfig.delay&&"2000"===u.nodemonConfig.delay?d.match("nodemon "+s):d.match("nodemon --delay 2000ms "+s),g&&g[0]&&(e.options.startScript=g[0],o=!0)}o||m("scripts",u.scripts)}return options&&e.options&&(options=e.options),e.options}}catch(p){p.code}},setPkgConfig:function(t){let n=null,o=null,s=null,i=null,l=null,f=r.processFilename,m=!1,u=!1,g=!1,d=c.test(f),p=a.test(f),h=f.indexOf("\\"),y=f.indexOf("/");try{if(d||p)return console.log("* package.json auto config failed"),void console.log("* Please configure manually your package.json");if(-1!==h||-1!==y)return console.log("** package.json auto config failed"),void console.log("** Please configure manually your package.json");if(t&&!t.options&&(t.options={}),n=fs.readFileSync("./node_modules/m2m/package.json"),s=fs.readFileSync("./package.json"),Buffer.isBuffer(s)&&(s=JSON.parse(s.toString())),"object"!=typeof s)throw new Error("Invalid package.json");if(0===Object.keys(s).length)throw new Error("Invalid package.json");i=fs.readFileSync("package.orig.json")}catch(e){n||(console.log("\nAuto config fail. Cannot find/resolve node_modules directory."),console.log("The package m2m requires that the node_modules directory must be\ninside the project's root directory.\n"),console.log("Please configure your package.json manually.\n"),process.exit()),s?fs.writeFileSync("package.orig.json",JSON.stringify(s,null,2)):(s={},s.name="m2m-application",s.version="1.0.0",s.dependencies={m2m:"^"+m2mv.version})}finally{try{console.log("\nConfiguring your package.json for m2m auto-restart ...\n"),s&&(s.name||(s.name="m2m-application"),s.version||(s.version="1.0.0")),s&&s.dependencies?s.dependencies.m2m="^"+m2mv.version:s.dependencies={m2m:"^"+m2mv.version},s.m2mConfig={code:{allow:!0,filename:f}},t.options.m2mConfig=s.m2mConfig,t.options.processFilename=f,m=!0,s.nodemonConfig={delay:"2000",verbose:!0,restartable:"rs",ignore:[".git","public"],ignoreRoot:[".git","public"],execMap:{js:"node"},watch:["node_modules/m2m/mon"],ext:"js,json"},t.options.nodeConfig=!0,t.options.nodemonConfig=!0,u=!0,l="nodemon "+f,s.scripts={},s.scripts.start=l,t.options.startScript=l,g=!0,fs.writeFileSync("package.json",JSON.stringify(s,null,2)),fs.readFileSync("./package.json"),m&&u&&g||(console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail"),process.exit()),n=fs.readFileSync("./node_modules/m2m/package.json");try{o=fs.readFileSync("./node_modules/nodemon/package.json"),console.log("nodemon already installed.\n")}catch(t){o||(console.log("Installing nodemon ...\n"),"-config"!==e.argv[0]&&"-cp"!==e.argv[0]||spawnSync("npm i nodemon",{stdio:null,shell:!0}))}try{fs.readFileSync("./node_modules/m2m/package.json"),fs.readFileSync("./node_modules/nodemon/package.json"),e.logEvent("auto-restart package.json configuration - success")}catch(t){e.logEvent("setPkgConfig verify install error:",t.message),console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail"),process.exit()}console.log(colors.brightGreen("Configuration done.")),setImmediate((()=>{s&&console.log("\nPlease verify the changes in your package.json."),i&&console.log("\nYou can revert to your original existing package.json\nusing the backup copy("+colors.brightGreen("package.orig.json")+")."),console.log("\nRestart your application using",colors.brightGreen("npm start")+".\n"),process.exit()}))}catch(t){e.logEvent("setPkgConfig error:",t.message)}}},setEpSecPolicy:function(t){try{let e=n.getSystemConfig(t);t.id&&(e.id=t.id),"server"==t.dst&&(e.server=t.dst),"client"==t.dst&&(e.client=t.dst),"user"==t.dst&&(e.user=t.dst),!0!==t.fim&&!1!==t.fim||(e.fim=t.fim,!0===e.fim?(m(),t.result=!0):!1===e.fim&&(e.ea=!1,e.ar=!1,u(),t.result=!0)),!0!==t.ea&&!1!==t.ea||(e.ea=t.ea),!0!==t.ar&&!1!==t.ar||(e.ar=t.ar),!0!==t.zta&&!1!==t.zta||(e.zta=t.zta),e=n.setSystemConfig(e),t.sc=e,setImmediate((()=>{o.emit("ws-emit-send",t)}))}catch(t){e.logEvent("setEpSecPolicy error:",t.message)}},setEnableStatus:g,getEnableStatus:d,setExitEvent:function(t){let s=Object.assign({},spl);delete s.options,delete s.systemInfo,delete s.sconfig,delete s.tid,delete s.ak,delete s.restartable,s._pid="exit",s.exit=!0,s.active=!1,function(t){let s="exit-process";o.listenerCount(s)<1&&o.once(s,(o=>{!function(t){const o="process exited ("+process.pid+")";e.logEvent(o,"");try{let e=n.getSystemConfig();e.fim&&(t.fim=!0,t.sconfig=e,t.item={af:!0,fn:r.processFilename},t._pid="fi-change",t.enable=!0),socket.send(t)}catch(e){console.log("executeExitEventProcess error:",e.message)}}(t)}))}(s),process.on("SIGINT",(e=>{o.emit("exit-process"),setTimeout((()=>process.exit()),200)})),process.on("exit",(e=>console.log("")))},getCurrentServer:function(){return i},setCurrentServer:function(e){return e&&"object"==typeof e?e&&e.server&&(i=e.server):e&&"string"==typeof e&&(i=e),e&&(l=e),i},setDefaultSecConfig:function(t){try{let e=n.getSystemConfig();0===Object.keys(e).length&&(e={id:t.id,src:t.src,enable:!0,fim:!1,ea:!1,ar:!1},n.setSystemConfig(e)),t.enable=e.enable,g(e.enable),!1===e.enable&&"r-ep"===pl_pid&&setTimeout((()=>{spl.server||t.server?console.log("\nServer is disabled\n"):spl.client||t.client?console.log("\nClient is disabled\n"):(spl.user||t.user)&&console.log("\nuser/edge is disabled\n")}),500)}catch(t){e.logEvent("setDefaultSecConfig error:",t.message)}},getUserResources:function(n,r,s){try{if(t||(t=dmLib(e)),n.active=!0,n.enable=d(),n.server&&n.getUserResources)if(n.startAccessRateMonitor){if(t&&s)return t.resources.startMonitorAccessRate(s,e)}else if(n.stopAccessRateMonitor){if(t)return t.resources.stopMonitorAccessRate(e)}else n.getUserResources&&(s&&(s.serverSetup.id=n.id,n.serverSetup=s.serverSetup),t&&(n.serverTotalAccessRate=t.resources.getserverAccessRateData()));else n.client&&n.getUserResources&&t&&r&&(n.clientAccessData=t.resources.getClientAccessData(r));setImmediate((()=>{o.emit("ws-emit-send",n)}))}catch(t){e.logEvent("getUserResources error:",t.message)}},setInitEpSecPolicy:function(t){try{let e=n.getSystemConfig(t);Object.keys(t).length>0&&(!0!==t.enable&&!1!==t.enable||(e.enable=t.enable),!0!==t.fim&&!1!==t.fim||(e.fim=t.fim),!0!==t.ea&&!1!==t.ea||(e.ea=t.ea),!0!==t.ar&&!1!==t.ar||(e.ar=t.ar),!0!==t.zta&&!1!==t.zta||(e.zta=t.zta),e.fim?m():e.fim||u()),n.setSystemConfig(e)}catch(t){e.logEvent("startup setInitEpSecPolicy error:",t.message)}},validateUserOptions:f,getConnectionOptions:function(){return l}}},exports.secLib=function(t,n,r,o,s){const i=[],a=1e6,c={regex:/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})*$/,msg:"Invalid userid. It must follow a valid email format."},l={regex:/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*()\\[\]{}\-_+=~|:;<>,./? ])(?=.{6,})/,msg:"Password must be at least 8 characters long but not over 50 characters long.\nIt must have at least one number, one lowercase letter, one uppercase letter, and one special character."};let f={_sid:"ckm",_pid:null,rk:!0,nodev:process.version,m2mv:m2mv.version,rid:t.rid(4)},m=null,u=5e3,g=15,d={},p={},h=!0,y=t.secTkn.getPtk(),v=(t.secTkn.getRtk(),t.secTkn.getRpk(),null),S=null,E=n.getSystemConfig();function w(){try{return fs.readFileSync(y,"utf8").slice(0,27)}catch(e){"ENOENT"===e.code&&t.secTkn.initSec()}}function b(){let e=null;try{return e=JSON.parse(Buffer.from(fs.readFileSync(w(),"utf8"),"base64").toString("utf8")),e}catch(t){return e}}function C(e,n){try{return fs.writeFileSync(e,n)}catch(e){t.logEvent("setCtk error:",e.message)}}function k(o){if(t.getRestartStatus())return;let s=null,i=null;try{s=fs.readFileSync("node_modules/m2m/package.json","utf8"),i=fs.readFileSync("node_modules/nodemon/package.json","utf8")}catch(e){t.logEvent("enableAutoRestartConfig fs.readFileSync error:",e.message)}if(!s)return void t.logEvent("enableAutoRestartConfig missing m2m module error:",e.message);let a=Math.floor(5e3*Math.random()+1e3);o.active=!0;try{t.getRestartStatus()?t.getRestartStatus()&&(E.monFileStatus="enable-auto-restart",n.setSystemConfig(E),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","enable-auto-restart")),a)):(0===Object.keys(options).length?r.setPkgConfig({}):Object.keys(options).length>0&&(options.m2mConfig&&options.processFilename&&options.nodemonConfig&&options.startScript||r.setPkgConfig({})),s&&!i&&spawnSync(o.cmd[1],o.option[0]),setTimeout((()=>{spawnSync(o.cmd[2],o.option[1])}),a))}catch(e){t.logEvent("enableAutoRestartConfig error:",e.message)}}function F(){return new Date}function x(e){let t="";for(let n=0;n<e;n++)t+="=";return t}"-rs"===processArgs[0]&&processArgs[1]&&(S=parseInt(processArgs[1]),Number.isInteger(S)&&(g=S),S>120&&(g=120)),function(){let e=require.main.filename,t=0;t="win32"===process.platform?e.lastIndexOf("\\"):e.lastIndexOf("/"),v=e.slice(t+1,t+50),s.processFilename=v}();let A=x(60)+"\n"+F()+"\n"+x(60);function O(e,t,n){A=x(60)+"\n"+F()+"\nEndpoint id: "+e.id,fs.appendFileSync(e.filename,A+"\ncommand [ "+e.cli+" ]\n"),setTimeout((()=>{fs.appendFileSync(e.filename,t),e.brCliStore=i,function(e){let t=null;try{t=fs.readFileSync(e.filename,"utf8"),t.length>a&&(t=D(t,e));let n=Buffer.from(t);e.cliLogData=n.toString("base64")}catch(t){N(t,e)}}(e),setImmediate(n,e)}),500)}function I(e){try{"server"===e.dst?e.src="server":"client"===e.dst?e.src="client":"user"===e.dst&&(e.src="user"),e.dst="browser",e.response=!0,e.pl=null,socket.send(e)}catch(e){t.logEvent("processBrCli error:",e.message)}}function j(e,n){let r=!1;try{if(i.length>0)for(let t=0;t<i.length;t++)if(i[t]&&i[t].cmd&&e.cli&&i[t].cliId===e.cliId&&i[t].cmd===e.cli)return r=!0,e.completed=!0,n&&n(!0,t),setTimeout((()=>i.splice(t,1)),100);r||n&&n(!1)}catch(n){setTimeout((()=>{e.result="Command [ "+e.cli+" ] execution error. Please try again later.\n",t.logEvent("removeCliProcess error:",n.message),I(e)}),500)}}function T(e,n){try{let t=Buffer.from(e);n.uploadEventLog?n.eventLogData=t.toString("base64"):(n.uploadCliLog||n.scli)&&(n.cliLogData=t.toString("base64")),n.success=!0}catch(e){n.error="The was an error loading the log file. You can try again later.",t.logEvent("msgBundle error:",e.message)}finally{o.emit("ws-emit-send",n)}}function N(e,n){if("ENOENT"===e.code){let r="Endpoint id: "+n.id+"  -  Log file not found\n";return t.logEvent("logFileError:",r,e.message),T(r,n)}let r="Log file error";return t.logEvent("logFileError:",r,e.message),T(r,n)}function D(e,n){try{let t=A+"\nLog file has reached its max. allowable size.\nFile is truncated ...\n\n"+e.slice(-1e4);return fs.writeFileSync(n.filename,t),t}catch(e){t.logEvent("truncateLogFile error:",e.message)}}function R(e,n){let o=null,s=null;try{o=r.getCurrentServer(),d.v=crypto.createVerify("SHA256"),d.v.update(r.defaultNode),d.v.end(),f._pid=e,f.node=r.defaultNode,m=setTimeout((()=>{console.log("\nThere was no response from the server.\nEither the server is down or you are connecting to an invalid server.\n"),process.kill(process.pid,"SIGINT")}),u)}catch(e){return console.log("getEpCk - node server certificate verification fail:",e.message),void t.logEvent("getEpCk crypto.createVerify error:",JSON.stringify(e))}if(o)try{let e=o.replace("https","wss");s=new _WebSocket(e+"/ckm",{origin:o})}catch(e){t.logEvent("getEpCk (invalid server) server.replace error:",JSON.stringify(e)),console.log("\nInvalid remote server address ...\nPlease confirm if you are connecting to a valid server.\n"),process.kill(process.pid,"SIGINT")}return"dck"===e&&(d.edh=crypto.createECDH("secp521r1"),d.edhpk=d.edh.generateKeys(),f.bk=d.edhpk.toString("base64")),s.on("open",(()=>{1===s.readyState&&s.send(JSON.stringify(f),(e=>{e&&t.logEvent("getEpCk ws open JSON.stringify(rkpl) send error:",JSON.stringify(e))}))})),s.on("error",(e=>{console.log(e),"Unexpected server response: 502"===e.message&&(console.log(colors.yellow("\nRemote server is not responding")," ...\nPlease try again later ...\n"),process.kill(process.pid,"SIGINT"))})),new Promise(((r,o)=>{s.on("message",(o=>{if(clearTimeout(m),1===s.readyState)try{o=JSON.parse(o),"dck"===e&&(d.vrfd=d.v.verify(o.puk,Buffer.from(o.bk,"base64")),d.vrfd&&(n?process.nextTick(n,null,o):r(o)))}catch(e){if(t.logEvent("getEpCk JSON.parse(ck) error:",JSON.stringify(e)),d=null,n)return n(e,null);r(e)}finally{s.close(),setTimeout((()=>o=null),3e3)}}))}))}function _(e,n){try{return e.dpk=n.puk,e.algo="aes-256-gcm",e.rnd=1e4,e.nk=Buffer.from(n.nk,"hex"),e.st=Buffer.from(n.st,"hex"),e.slt1=n.nk,e.slt2=n.st,e.csec=e.edh.computeSecret(Buffer.from(n.sk,"base64")),e.cipkey1=crypto.pbkdf2Sync(e.csec,e.slt1,e.rnd,32,"sha256"),e.cipkey2=crypto.pbkdf2Sync(e.csec,e.slt2,e.rnd,32,"sha256"),e}catch(r){throw t.logEvent("setEncKey error:",JSON.stringify(r)),e=null,n=null,r}}async function M(e,n,r){try{const s=await R("dck");if(d=_(d,s),e)if(d.uc={},d.at={},"string"==typeof e?d.uc=e:"object"==typeof e&&(e.name&&e.password?(d.uc.userid=e.name,d.uc.userpw=e.password,d.uc=JSON.stringify(d.uc)):d.uc=JSON.stringify(e)),"priv"===r){if(!d.cipkey1)throw new Error("invalid private key");d.at.aad=Buffer.from(t.rid(12),"hex"),d.cp=crypto.createCipheriv(d.algo,d.cipkey1,d.nk,{authTagLength:16}),d.cp.setAAD(d.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(d.uc))}),d.uc=d.cp.update(d.uc,"utf8"),d.cp.final(),d.at.tag=d.cp.getAuthTag(),n.euc=d.uc.toString("hex"),n.att=d.at.aad.toString("hex")+d.at.tag.toString("hex")}else{if("pub"!==r)throw new Error("invalid encryption type");if(!d.dpk)throw new Error("invalid public key");n.pd=crypto.publicEncrypt(d.dpk,Buffer.from(d.uc))}if(n.uid=d.slt1,n.idn=d.slt2,e.name&&e.password)return n;o.emit("ws-emit-send",n)}catch(e){throw t.logEvent("encryptData error:",JSON.stringify(e)),e}finally{setTimeout((()=>{d=null,n=null}),2e3)}}async function L(e,n,r,o,s){let i=null,a=null,f=(Math.floor(5e3*Math.random()+1e3),"One of your credentials is invalid");if(r.aid&&n.sc){if(n.sc.length>10)throw new Error(f)}else if(n.name&&n.password){if(i=n.name.search(c.regex),a=n.password.search(l.regex),n.name.length<5||n.name.length>50)throw new Error("Userid must be 5 characters minimum and 50 characters maximum.");if(n.password.length<8||n.password.length>50)throw new Error("Password must be 8 characters minimum and 50 characters maximum.");if(0!==i&&0!==a)throw new Error(f)}n.fe=JSON.stringify({u:n.name,p:n.password,s:n.sc});try{let i=await async function(e,n,r){try{if(e.be)n.be=Buffer.from(e.be).toString("base64"),n.uid=t.rid(8);else if(e.he)n.he=Buffer.from(e.he).toString("hex"),n.uid=t.rid(8);else if(e.fe){const r=await R("dck");d=_(d,r),e.name&&e.password&&(d.uc={},d.at={},d.uc.userid=e.name,d.uc.userpw=e.password,d.at.aad=Buffer.from(t.rid(12),"hex"),d.cp=crypto.createCipheriv(d.algo,d.cipkey1,d.nk,{authTagLength:16}),d.cp.setAAD(d.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(d.uc))}),d.ucs=d.cp.update(JSON.stringify(d.uc),"utf8"),d.cp.final(),d.at.tag=d.cp.getAuthTag(),n.euc=d.ucs.toString("hex"),n.att=d.at.aad.toString("hex")+d.at.tag.toString("hex")),e.sc&&(d.sc={},d.sccp=crypto.createCipheriv(d.algo,d.cipkey2,d.nk,{authTagLength:16}),d.sc.esc=d.sccp.update(e.sc,"utf8"),d.sccp.final(),d.sc.stag=d.sccp.getAuthTag(),n.esc=Buffer.from(JSON.stringify(d.sc),"utf8").toString("hex")),n.uid=d.slt1,n.idn=d.slt2}return n}catch(e){throw t.logEvent("encryptUser (system/process) error:",JSON.stringify(e)),e}finally{setTimeout((()=>{e=null,d=null,n=null}),2e3)}}(n,r);o.connect(e,i,s)}catch(e){throw t.logEvent("authenticate - encryptUser (system) error:",JSON.stringify(e)),"authenticate - encryptUser error"}}function U(e,n,r,o){let s=[];"v-ep"===n._pid&&(n._pid="r-ep"),s.push({type:"input",message:"Enter your userid (email):",name:"name",validate:e=>!(e.search(c.regex)<0)||c.msg}),s.push({type:"password",message:"Enter your password:",name:"password",mask:"*",validate:e=>!(e.search(l.regex)<0)||l.msg}),n.aid&&(n.at="sc")&&(s=[{type:"password",message:"*Enter your security code:",name:"sc",mask:"*",validate:e=>!(e.length>10)||"Invalid security code"}],n.vsc=!0),console.log("\nPlease provide your credentials ...\n"),inquirer.prompt(s).then((t=>{L(e,t,n,r,o)})).catch((e=>{e.isTtyError?t.logEvent("userPrompt - inquirer error.isTtyError:",JSON.stringify(e)):t.logEvent("userPrompt - inquirer error:",JSON.stringify(e))}))}function P(e,t,n,r){let o={_sid:"m2m"};return o.id=e,o.srcId=e,o[t]=!0,o[n]=o[t],o.src=t,o._pid=r,o.active=!0,o.enable=!0,o.at="up","server"===t&&(o.serverId=e),"server"===t?o.serverId=e:"client"===t?o.clientId=e:"user"===t?o.userId=e:"endpoint"===t&&(o.endpointId=e),o}function J(e){try{let n=t.rid(4),r=b();if(e&&!e.options&&(e.options={}),e.arg&&"object"==typeof e.arg&&e&&e.options&&(e.options.userSettings=e.arg),e.ep){if(r&&r.ep)return r.options=e.options,e.edgeEp?r.edgeEp=e.edgeEp:e.edgeUser&&(r.edgeUser=e.edgeUser),r;{const t=P(n,"endpoint","e","r-e");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.server){if(r&&r.id!==e.id&&(r=null),r&&r.server)return r.options=e.options,e.edgeEp?r.edgeEp=e.edgeEp:e.edgeUser&&(r.edgeUser=e.edgeUser),r;{const t=P(e.id,"server","d","r-ep");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.client){if(r&&r.client)return r.options=e.options,e.edgeEp?r.edgeEp=e.edgeEp:e.edgeUser&&(r.edgeUser=e.edgeUser),r;{const t=P(n,"client","c","r-ep");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.user||e.edgeEp||e.edgeUser){if(r&&r.user)return r.options=e.options,r;{const t=P(n,"user","u","r-ep");return e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t.options=e.options,t}}}catch(e){console.log("getEndpoint error:",e.message)}}async function B(e,t,r,o){try{let s=n.getSystemConfig();if(s.monFileStatus="reset",n.setSystemConfig(s),"-r"===processArgs[0]&&(t=J(t)),t._sid="m2m",t.tid=Date.now(),t.aid?t.at="sc":t.at="pu",e&&"object"==typeof e){if(e.userid&&e.pw&&e.sc){"-r"!==processArgs[0]&&console.log("current user:",e.userid,"\n"),e.trial&&(t.trial=e.trial,t.startDate=Date.now());let n={};return n.name=e.userid,n.password=e.pw,n.sc=e.sc,"-r"===processArgs[0]?U(e,t,r,o):L(e,n,t,r,o)}if(o)return o(new Error("invalid credentials"))}U(e,t,r,o)}catch(e){throw new Error("m2mStart error:",e.message)}}return setTimeout((()=>{!function(){let e=Math.floor(5e3*Math.random()+1e3),r="m2m-module-update";o.listenerCount(r)<1&&o.on(r,(r=>{try{fs.readFileSync("./node_modules/m2m/package.json")}catch(e){return r.active=!0,r.error="Update fail. Cannot find/resolve node_modules directory.",delete r.file,delete r.code,o.emit("ws-emit-send",r),void t.logEvent("m2m module update error:",e.message)}if(r.aid===spl.aid){try{JSON.parse(r.file.package)}catch(e){return void t.logEvent("setModuleUpdateListener JSON.parse(rxd.file.package) error:",e.message)}n&&(n.stopMonEpFS(),n.stopMonEpApp());try{if(!r.path&&!r.file)return;r.file.client&&r.path.client&&fs.writeFileSync(r.path.client,r.file.client),r.file.m2m&&r.path.m2m&&fs.writeFileSync(r.path.m2m,r.file.m2m),r.file.supportLib&&r.path.supportLib&&fs.writeFileSync(r.path.supportLib,r.file.supportLib),r.file.nodeEdge&&r.path.nodeEdge&&fs.writeFileSync(r.path.nodeEdge,r.file.nodeEdge),r.file.package&&r.path.package&&fs.writeFileSync(r.path.package,r.file.package),setImmediate((()=>{r.active=!0,r.update="success",t.getRestartStatus()&&(r.restartable=!0),delete r.file,delete r.code,o.emit("ws-emit-send",r),t.logEvent("m2m module updated","v"+r.ver),r.restartable&&setTimeout((()=>{E.monFileStatus="m2m-module-update",n.setSystemConfig(E),fs.writeFileSync("node_modules/m2m/mon","m2m-module-update")}),e)}))}catch(e){t.logEvent("setModuleUpdateListener fs.writeFileSync(path.client, client) error:",e)}}}))}()}),100),{setCtk:C,readCtk:b,decSC:function(e,n){if(p&&Object.keys(p).length>0)try{return p.dec=crypto.createCipheriv(p.algo,p.cipkey2,p.nk,{authTagLength:16}),p.decData=p.dec.update(e.edata,"hex","utf8"),p.decData+=p.dec.final("utf8"),n?n(null,p.decData):p.decData}catch(e){if(t.logEvent("decSC error:",JSON.stringify(e)),n)return n(e,null);throw e}finally{setTimeout((()=>{e=null,p=null}),2e3)}},m2mStart:B,m2mRestart:function(e,r,o,s){try{r=J(r);let i=n.getSystemConfig();if(i.zta&&(r.aid?r.at="sc":r.at="pu",!i||i&&"reset"===i.monFileStatus))return void B(e,r,o,s);if(r.aid&&r.did)return void process.nextTick(o.connect,e,r,s);let a=w(),c=fs.readFileSync(a,"utf8"),l=JSON.parse(Buffer.from(c,"base64").toString("utf8"));setImmediate((()=>{!function(e,n,r,o,s){try{if(console.log("\n"),n.client&&r.id&&"number"==typeof r.id)return console.log("Endpoint has changed from server to client, please register your new client."),B(e,n,o,s);if(n.client&&r.client&&r.clientId&&r.clientId!==n.clientId)return console.log("Client id has changed from",r.id,"to",n.id,"please register your new client."),B(e,n,o,s);if(n.client&&r.user)return console.log("Endpoint has changed from user to client, please register your new client."),B(e,n,o,s);if(n.server&&r.client&&r.id&&"string"==typeof r.id)return console.log("Endpoint has changed from client to server, please register your new server."),B(e,n,o,s);if(n.server&&r.user&&r.id&&"string"==typeof r.id)return console.log("Endpoint has changed from user to server, please register your new server."),B(e,n,o,s);if(n.server&&r.id&&r.id!==n.id)return console.log("Server id has changed from",r.id,"to",n.id,", please register your new server."),B(e,n,o,s);if(n.server&&!r.id)return console.log("Registering new server.\n"),B(e,n,o,s);if(n.user&&(r.server||r.client))return console.log("Endpoint has changed from client/server to user/edge, please register new user/edge."),B(e,n,o,s);if(!(n.server||n.client||n.user||n.endpoint)){if(r.user)return console.log("Register new endpoint.\n"),B(e,n,o,s);console.log("Verifying existing endpoint."),r._pid="r-e"}process.nextTick(o.connect,e,r,s)}catch(e){t.logEvent("validateCtkn error:",JSON.stringify(e))}}(e,r,l,o,s)}))}catch(n){try{let n=fs.readFileSync(t.secTkn.getRtk(),"utf8"),r=JSON.parse(Buffer.from(n,"base64").toString("utf8")),i=Object.assign({},r);B(e,i,o,s)}catch(t){B(e,r,o,s)}}},userPrompt:U,autoRestart:function(e){try{E.monFileStatus="auto-restart",n.setSystemConfig(E),e.server?fs.writeFileSync("node_modules/m2m/mon","auto-restart"):setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","auto-restart")),1e3)}catch(e){t.logEvent("autoRestart error:",e.message)}},rxCommonData:function(e,s,c,l){try{if(e.restart)l&&l.access(e),function(e){try{try{fs.readFileSync("./node_modules/m2m/package.json")}catch(n){return e.active=!0,e.error="Update fail. Cannot find/resolve node_modules directory.",o.emit("ws-emit-send",e),void t.logEvent("restart error:",n.message)}let s=Math.floor(5e3*Math.random()+1e3);e.active=!0,e.result="fail",e.restartable=!1,e.enable=r.getEnableStatus(),t.getRestartStatus()&&(n&&(n.stopMonEpFS(),n.stopMonEpApp()),e.data&&C(e.path,e.data),e.result="success",e.restartable=!0,t.logEvent("process restarted remotely"),E.monFileStatus="m2m-restart-process",n.setSystemConfig(E),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","m2m-restart-process")),s)),o.emit("ws-emit-send",e)}catch(e){t.logEvent("restartProcess error:",e.message)}}(e);else if(e.status)!function(e,s,i){try{e.options=options,e.systemInfo=t.systemInfo,e.active=!0,e.enable=r.getEnableStatus(),e.containerized=t.systemInfo.container;let a=n.getSystemConfig(e);a&&(e.sc=a),t.getRestartStatus()&&(e.restartable=!0),"client-status"===e._pid?(dm||(dm=dmLib(t)),dm&&s&&(e.clientserverId=s.getValidServers(),e.clientAccessData=dm.resources.getClientAccessData(s))):"server-status"===e._pid&&i&&i.serverSetup&&(e.serverSetup=i.serverSetup);try{let t=fs.readFileSync("./node_modules/m2m/package.json","utf8");if(t){let n=JSON.parse(t);e.systemInfo.m2mv="v"+n.version}}catch(e){console.log("readFileSync pkgJson error:",e.message)}setImmediate((()=>{o.emit("ws-emit-send",e)}))}catch(e){t.logEvent("getEndpointStatus error:",e.message)}}(e,s,c);else if(e.secureSystem)!function(e){try{e.active=!0,e.on&&(h=!1),e.result="success",t.logEvent("process","secure system enabled"),o.emit("ws-emit-send",e)}catch(e){t.logEvent("secureSystem error:",e.message)}}(e);else if(e.updateCode)!function(e){e.active=!0;try{if(!e.appData)return e.appData="filename does not exist.",e.error={permission:!0,file:null},o.emit("ws-emit-send",e);if(e.updateCode&&Object.keys(options).length>0&&options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow){if(options.m2mConfig.code.filename){t.getRestartStatus()&&(e.restartable=!0),n&&n.stopMonEpApp();let r=Buffer.from(e.appData,"base64").toString("utf8");return!1===r.includes("require('m2m')",0)?void t.logEvent("updateCode error:remote browser app code is not in utf8 format"):fs.writeFile(options.m2mConfig.code.filename,r,(r=>{if(r)return"ENOENT"===r.code?e.appData="filename does not exist.":e.appData=r,t.logEvent("application code update error:",r.message),e.error={permission:!0,file:null},o.emit("ws-emit-send",e);delete e.appData,e.success=!0,o.emit("ws-emit-send",e),n&&n.startMonEpApp(options.m2mConfig.code.filename),t.logEvent("application code updated",options.m2mConfig.code.filename),setImmediate((()=>{E.monFileStatus="app-code-update",n.setSystemConfig(E),fs.writeFileSync("node_modules/m2m/mon","app-code-update")}))}))}return e.error={permission:!0,file:null},t.logEvent("updateCode missing filename error:",options.m2mConfig),o.emit("ws-emit-send",e)}e.error={permission:!1},t.logEvent("updateCode missing options.m2mConfig.code error:",options),o.emit("ws-emit-send",e)}catch(e){t.logEvent("updateCode error:",e.message)}}(e);else if(e.uploadCode)!function(e){e.active=!0;try{if(e.uploadCode&&Object.keys(options).length>0)return options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow&&options.m2mConfig.code.filename?(e.processFilename=options.m2mConfig.code.filename,function(e,n){let s=r.getConnectionOptions();fs.readFile(e,"utf8",((e,r)=>{try{if(e)return"ENOENT"===e.code?n.appData="filename does not exist.":n.appData=e,n.error={permission:!1,file:null},o.emit("ws-emit-send",n);let t=Buffer.from(r);if(s&&s.pw)return n.error={pw:!0,permission:!1,file:null},o.emit("ws-emit-send",n);n.success=!0,n.enc?M(r,n,"priv"):(n.appData=t.toString("base64"),o.emit("ws-emit-send",n))}catch(e){t.logEvent("getCodeData error:",e.message)}}))}(options.m2mConfig.code.filename,e)):(e.error={permission:!0,file:null},o.emit("ws-emit-send",e));e.error={permission:!1},o.emit("ws-emit-send",e)}catch(e){t.logEvent("uploadCode error:",e.message)}}(e);else if(e.uploadCliLog)!function(e){e.active=!0,e.uploadCliLog&&function(e){try{let t=fs.readFileSync(e.filename,"utf8");if(t.length>a)return T(D(t,e),e);if(e.enc)return M(t,e,"priv");T(t,e)}catch(t){N(t,e)}}(e)}(e);else if(e.clearCliLog)!function(e){e.active=!0;try{t.rid(4),fs.readFileSync(e.filename,"utf8"),setTimeout((()=>{(e.clearCliLog||e.clearEventLog)&&function(e){let n="";e.clearEventLog&&(n=t.eventLogHeader);try{fs.writeFileSync(e.filename,n),e.success=!0,o.emit("ws-emit-send",e)}catch(t){return N(t,e)}}(e)}),300)}catch(n){t.logEvent("clearLogFile error:",n.message),e.error="Cannot clear log file",o.emit("ws-emit-send",e)}}(e);else if(e.acli)!function(e){e.success=!0,j(e,((n,r)=>{try{n?(i[r].cli.kill("SIGSTOP"),i[r].cli.killed?O(e,"Aborted\n\n",I):O(e,"Abort fail\n\n",I)):O(e,"Already executed, nothing to abort\n\n",I)}catch(e){t.logEvent("aCli error:",e.message)}}))}(e);else if(e.scli){if(e.ers)return l&&l.access(e),void k(e);!function(e){try{if(e.ers)return k(e);!function(e,n,r){let o=null,s="",a=null;try{e.opt&&(a=e.opt);let c=spawn(n,{stdio:a,shell:!0}),l={cli:c,cmd:e.cli,pid:c.pid,killed:c.killed,cliId:e.cliId};i.push(l),n=null,e.success=!0,"win32"!==process.platform&&(o=setTimeout((()=>{s+=e.crp,j(e),O(e,s+"\n",r)}),3e3),c.stdout.on("data",(e=>{s+=e.toString(),clearTimeout(o)})),c.stderr.on("data",(e=>{let t=e.toString().search("no password was provided"),n=e.toString().search("password for");-1===t&&-1===n&&(s+=e.toString())}))),c.on("close",((t,n)=>{clearTimeout(o),n&&(s+="Command aborted\n"),e.code=t,j(e),O(e,s+"\n",r)})),c.on("exit",((e,t)=>{})),c.on("node-m2m-error",(n=>{t.logEvent("cli execution error:",n.toString()),O(e,s+"error: "+n.toString()+"\n",r)})),c.stdin.end()}catch(n){t.logEvent("exeBrCli error:",n.message),O(e,"Execution error. Please try again later.\n\n",r)}}(e,Buffer.from(e.pl,"base64").toString("utf8"),(e=>{I(e)}))}catch(e){t.logEvent("eCli error:",e.message)}}(e)}else e.setEpSec?r.setEpSecPolicy(e):e.suspend?n.suspend(e,c):e.getUserResources||e.startAccessRateMonitor||e.stopAccessRateMonitor?r.getUserResources(e,s,c):e.edgeResources?l&&l.resources(e):e.accessEdge&&l&&l.access(e)}catch(e){t.logEvent("rxCommonData error:",e.message)}},getCurrentProcessName:function(){return v}}};